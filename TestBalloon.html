<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>ORIX Financial Lease Calculator ‚Äî Minimal (Editable vs Auto)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Google Font: Noto Sans Thai (‡∏ö‡∏≤‡∏á/‡πÄ‡∏ö‡∏≤) -->
  https://fonts.googleapis.com
  https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;600;700&display=swap
  <style>
:root {
  /* ORIX Minimal palette */
  --orix-blue: #003366;     /* primary accent */
  --blue-600: #0A3B6F;
  --blue-050: #F6FAFD;

  --ink-900: #12161C;
  --ink-700: #2E3A46;
  --ink-600: #475569;
  --ink-500: #64748B;
  --line: #E6EBF0;
  --white: #FFFFFF;

  /* Inputs: editable vs readonly (‡πÅ‡∏¢‡∏Å‡∏™‡∏µ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô) */
  /* ‚ñº ‡πÉ‡∏´‡∏°‡πà: ‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡∏≠‡πà‡∏≠‡∏ô‡∏°‡∏≤‡∏Å ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡πÑ‡∏î‡πâ */
  --editable-bg: #FFFDF0;          /* very light yellow */
  --editable-border: #F3E6BA;      /* warm light border */

  /* ‚ñº ‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì/‡∏´‡πâ‡∏≤‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏â‡∏î‡πÅ‡∏≠‡∏°‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏≠‡πà‡∏≠‡∏ô‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) */
  --readonly-bg: #FFF4E5;          /* soft amber */
  --readonly-border: #F3CDA0;
  --readonly-text: #7A4E00;

  /* ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏Ñ‡πâ‡∏áÁµ±‰∏Ä (‡πÉ‡∏ä‡πâ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á editable/readonly) */
  --input-radius: 12px;

  --ring: rgba(0, 51, 102, 0.25);
  --shadow: 0 8px 24px rgba(18, 22, 28, 0.06);
  --radius: 12px;

  /* Tag colors */
  --tag-edit-bg: #E9F3FF;     /* light blue */
  --tag-edit-text: #0B3A6A;
  --tag-ro-bg: #FFE9C9;       /* light amber */
  --tag-ro-text: #7A4E00;
}

/* ‚Ä¶ (‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ‚Ä¶ */

/* ‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡πÑ‡∏î‡πâ (Editable) ‚Äî ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡∏≠‡πà‡∏≠‡∏ô + ‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡∏™‡∏µ ORIX */
.control input:not([readonly]),
.control select {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid var(--editable-border);
  border-radius: var(--input-radius);   /* ‡πÉ‡∏ä‡πâ‡∏°‡∏∏‡∏°‡πÇ‡∏Ñ‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô */
  background: var(--editable-bg);       /* ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡∏≠‡πà‡∏≠‡∏ô‡∏°‡∏≤‡∏Å */
  color: var(--ink-700);
  text-align: right;
  font-weight: 400;
  outline: none;
  transition: .15s ease;
}
.control input#carInfo { text-align: left; }
.control input:focus,
.control select:focus {
  border-color: var(--orix-blue);
  box-shadow: 0 0 0 3px var(--ring);
  background: #fff;
}

/* ‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì/‡∏´‡πâ‡∏≤‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (Read-only/Disabled) ‚Äî ‡πÇ‡∏Ñ‡πâ‡∏á‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á */
.control input[readonly],
.control select:disabled,
.control input:disabled {
  background: var(--readonly-bg);
  border: 1px solid var(--readonly-border);
  color: var(--readonly-text);
  cursor: not-allowed;
  font-weight: 600;
  border-radius: var(--input-radius);   /* <-- ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÇ‡∏Ñ‡πâ‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô */
}

    main {
      max-width: 1100px;
      margin: 16px auto 28px;
      padding: 0 16px;
    }

    /* Card */
    .card {
      background: var(--white);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    .card + .card { margin-top: 14px; }
    .card-head {
      padding: 12px 14px;
      border-bottom: 1px solid var(--line);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
    .card-head h2 {
      margin: 0;
      font-size: 14px;
      font-weight: 600;
      color: var(--orix-blue);
      letter-spacing: .2px;
    }

    /* Legend for tags */
    .legend {
      display: flex; align-items: center; gap: 10px; flex-wrap: wrap;
      font-size: 12px; color: var(--ink-600);
    }
    .tag {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 3px 8px; border-radius: 999px;
      font-size: 12px; font-weight: 600;
      border: 1px solid transparent;
      user-select: none;
    }
    .tag .ico { font-size: 12px; line-height: 1; }
    .tag-edit { background: var(--tag-edit-bg); color: var(--tag-edit-text); border-color: #CCE6FF; }
    .tag-ro   { background: var(--tag-ro-bg);   color: var(--tag-ro-text);   border-color: #F6D9A8; }

    /* Grid */
    .grid { display: grid; grid-template-columns: 1fr; gap: 12px; padding: 12px; }
    @media (min-width: 900px) { .grid.two { grid-template-columns: 1fr 1fr; } }

    /* Section + Fields */
    .section { border-radius: 10px; overflow: hidden; border: 1px solid var(--line); }
    .fields { display: grid; grid-template-columns: 1fr; }
    @media (min-width: 640px) { .fields { grid-template-columns: 1fr 1fr; } }

    .field {
      display: grid; grid-template-columns: 46% 54%;
      align-items: center; gap: 10px; padding: 10px 12px;
      border-bottom: 1px solid var(--line); background: #fff;
    }
    .field:nth-child(even) { background: #FCFEFF; }
    .field:last-child { border-bottom: none; }

    .label {
      font-size: 13px; color: var(--ink-600);
      display: flex; align-items: center; gap: 8px; flex-wrap: wrap;
      font-weight: 400;
    }

    .control input:not([readonly]), .control select {
      width: 100%; padding: 10px 12px;
      border: 1px solid var(--editable-border);
      border-radius: 10px; background: var(--editable-bg);
      color: var(--ink-700); text-align: right; font-weight: 400; outline: none; transition: .15s ease;
    }
    .control input#carInfo { text-align: left; }
    .control input:focus, .control select:focus {
      border-color: var(--orix-blue);
      box-shadow: 0 0 0 3px var(--ring);
      background: #fff;
    }

    /* Readonly / disabled explicit style (‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô) */
    .control input[readonly] {
      background: var(--readonly-bg);
      border: 1px solid var(--readonly-border);
      color: var(--readonly-text);
      cursor: not-allowed;
      font-weight: 600;
    }
    .control select:disabled,
    .control input:disabled {
      background: var(--readonly-bg);
      border: 1px solid var(--readonly-border);
      color: var(--readonly-text);
      cursor: not-allowed;
    }

    /* Button set */
    .actions { display: grid; gap: 10px; padding: 12px; grid-template-columns: 1fr 1fr; }
    @media (min-width: 680px) { .actions { grid-template-columns: repeat(4, 1fr); } }
    .btn {
      padding: 12px 14px; border: 1px solid transparent; border-radius: 10px;
      font-weight: 600; font-size: 14px; cursor: pointer; transition: .12s ease;
    }
    .btn:active { transform: scale(.99); }
    .btn-primary { background: var(--orix-blue); color: #fff; }
    .btn-primary:hover { background: var(--blue-600); }
    .btn-ghost { background: #fff; border-color: var(--line); color: var(--ink-700); }
    .btn-ghost:hover { border-color: var(--orix-blue); color: var(--orix-blue); }
    .btn-danger { background: #E30613; color: #fff; }
    .btn-danger:hover { background: #B0050D; }
  </style>
</head>
<body>
  <header>
    <div class="nav">
      <span class="brand"></span>
      <div class="title">ORIX Financial Lease Calculator</div>
    </div>
  </header>

  <main>
    <div class="grid two">
      <!-- LEFT: Inputs -->
      <div>

        <!-- Base Info -->
        <section class="card">
          <div class="card-head">
            <h2>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô</h2>
            <div class="legend">
              <span class="tag tag-edit"><span class="ico">‚úèÔ∏è</span> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ</span>
              <span class="tag tag-ro"><span class="ico">üîí</span> ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</span>
            </div>
          </div>
          <div class="section">
            <div class="fields">
              <div class="field">
                <div class="label">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏ñ <span class="tag tag-edit" data-tag></span></div>
                <div class="control"><input id="carInfo" type="text" value=""></div>
              </div>
              <div class="field">
                <div class="label">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ñ <span class="tag" data-tag></span></div>
                <div class="control"><input id="carPrice" type="text" value="0.00"></div>
              </div>
              <div class="field">
                <div class="label">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î <span class="tag" data-tag></span></div>
                <div class="control"><input id="discount" type="text" value="0.00"></div>
              </div>
              <div class="field">
                <div class="label">Option <span class="tag" data-tag></span></div>
                <div class="control"><input id="option" type="text" value="0.00"></div>
              </div>
              <div class="field">
                <div class="label">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ <span class="tag" data-tag></span></div>
                <div class="control"><input id="totalAmount" readonly></div>
              </div>
            </div>
          </div>
        </section>

        <!-- Down & Balloon -->
        <section class="card">
          <div class="card-head"><h2>‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå &amp; ‡∏ö‡∏≠‡∏•‡∏•‡∏π‡∏ô</h2></div>
          <div class="section">
            <div class="fields">
              <div class="field">
                <div class="label">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏î‡∏≤‡∏ß‡∏ô‡πå <span class="tag" data-tag></span></div>
                <div class="control">
                  <select id="downType">
                    <option value="percent">‡πÄ‡∏õ‡πá‡∏ô %</option>
                    <option value="amount">‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</option>
                  </select>
                </div>
              </div>
              <div class="field">
                <div class="label">‡∏Å‡∏£‡∏≠‡∏Å % ‡∏´‡∏£‡∏∑‡∏≠ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô <span class="tag" data-tag></span></div>
                <div class="control"><input id="downInput" type="text" value="0.00"></div>
              </div>
              <div class="field">
                <div class="label">‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå <span class="muted">( <span id="downPercentInline">0.0000%</span> )</span> <span class="tag" data-tag></span></div>
                <div class="control"><input id="downAmount" readonly></div>
              </div>

              <div class="field">
                <div class="label">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ö‡∏≠‡∏•‡∏•‡∏π‡∏ô <span class="tag" data-tag></span></div>
                <div class="control">
                  <!-- Default = amount -->
                  <select id="balloonType">
                    <option value="amount" selected>‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</option>
                    <option value="percent">‡πÄ‡∏õ‡πá‡∏ô % ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</option>
                  </select>
                </div>
              </div>
              <div class="field">
                <div class="label">‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏ö‡∏≠‡∏•‡∏•‡∏π‡∏ô <span class="tag" data-tag></span></div>
                <div class="control">
                  <select id="balloonPercentSelect" disabled>
                    <option value="5">5%</option>
                    <option value="10" selected>10%</option>
                    <option value="15">15%</option>
                    <option value="20">20%</option>
                    <option value="25">25%</option>
                    <option value="30">30%</option>
                    <option value="35">35% (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î)</option>
                  </select>
                </div>
              </div>
              <div class="field">
                <div class="label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ö‡∏≠‡∏•‡∏•‡∏π‡∏ô <span class="tag" data-tag></span></div>
                <div class="control"><input id="balloonManualInput" type="text" value="0.00"></div>
              </div>
              <div class="field">
                <div class="label">‡∏¢‡∏≠‡∏î‡∏ö‡∏≠‡∏•‡∏•‡∏π‡∏ô <span class="muted">( <span id="balloonPercentInline">0.0000%</span> )</span> <span class="tag" data-tag></span></div>
                <div class="control"><input id="balloonAmount" readonly></div>
              </div>
            </div>
          </div>
        </section>

        <!-- Interest & Commission -->
        <section class="card">
          <div class="card-head"><h2>‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢ &amp; ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°</h2></div>
          <div class="section">
            <div class="fields">
              <div class="field">
                <div class="label">‡πÇ‡∏´‡∏°‡∏î‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢ <span class="tag" data-tag></span></div>
                <div class="control">
                  <select id="interestMode">
                    <option value="flat" selected>‡∏Å‡∏≥‡∏´‡∏ô‡∏î Flat Rate (%)</option>
                    <option value="target_irr">‡∏Å‡∏≥‡∏´‡∏ô‡∏î IRR ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (% ‡∏ï‡πà‡∏≠‡∏õ‡∏µ)</option>
                  </select>
                </div>
              </div>
              <div class="field">
                <div class="label">Flat Rate (%) <span class="tag" data-tag></span></div>
                <div class="control"><input id="interestRate" type="text" value="0.00"></div>
              </div>
              <div class="field">
                <div class="label">IRR ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (% ‡∏ï‡πà‡∏≠‡∏õ‡∏µ) <span class="tag" data-tag></span></div>
                <div class="control"><input id="targetIrr" type="text" value="0.00" disabled></div>
              </div>
              <div class="field">
                <div class="label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏µ <span class="tag" data-tag></span></div>
                <div class="control"><input id="termYears" type="number" step="1" value="0"></div>
              </div>

              <div class="field">
                <div class="label">‡∏Ñ‡∏¥‡∏î‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏à‡∏≤‡∏Å <span class="tag" data-tag></span></div>
                <div class="control">
                  <select id="comBase">
                    <option value="interest">‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏£‡∏ß‡∏°</option>
                    <option value="finance">‡∏¢‡∏≠‡∏î‡∏à‡∏±‡∏î</option>
                  </select>
                </div>
              </div>
              <div class="field">
                <div class="label">Commission (%) <span class="tag" data-tag></span></div>
                <div class="control"><input id="comPercent" type="text" value="0.00"></div>
              </div>
              <div class="field">
                <div class="label">‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏° (Ex VAT) <span class="tag" data-tag></span></div>
                <div class="control"><input id="calculatedCommission" readonly></div>
              </div>
              <div class="field">
                <div class="label">Extra Commission (Ex VAT) <span class="tag" data-tag></span></div>
                <div class="control"><input id="extra" type="text" value="0.00"></div>
              </div>
            </div>
          </div>
        </section>

      </div>

      <!-- RIGHT: Results & OWS -->
      <div>

        <!-- Results -->
        <section class="card">
          <div class="card-head"><h2>‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</h2></div>
          <div class="section">
            <div class="fields">
              <div class="field">
                <div class="label">‡∏¢‡∏≠‡∏î‡∏à‡∏±‡∏î <span class="tag" data-tag></span></div>
                <div class="control"><input id="financeAmt" readonly></div>
              </div>
              <div class="field">
                <div class="label">‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏ï‡πà‡∏≠‡∏õ‡∏µ (Ex VAT) <span class="tag" data-tag></span></div>
                <div class="control"><input id="intPA" readonly></div>
              </div>
              <div class="field">
                <div class="label">‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏£‡∏ß‡∏° (Ex VAT) <span class="tag" data-tag></span></div>
                <div class="control"><input id="intTotal" readonly></div>
              </div>
              <div class="field">
                <div class="label">‡∏¢‡∏≠‡∏î‡∏à‡∏±‡∏î‡∏£‡∏ß‡∏° (‡∏ê‡∏≤‡∏ô‡∏ú‡πà‡∏≠‡∏ô) <span class="tag" data-tag></span></div>
                <div class="control"><input id="financeTotalWithInterest" readonly></div>
              </div>

              <!-- Installment breakdown -->
              <div class="field">
                <div class="label">‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î (Ex VAT) / ‡∏á‡∏ß‡∏î <span class="tag" data-tag></span></div>
                <div class="control"><input id="leaseExVat" readonly></div>
              </div>
              <div class="field">
                <div class="label">VAT 7% / ‡∏á‡∏ß‡∏î <span class="tag" data-tag></span></div>
                <div class="control"><input id="leaseVat" readonly></div>
              </div>
              <div class="field">
                <div class="label">‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î (In VAT) / ‡∏á‡∏ß‡∏î <span class="tag" data-tag></span></div>
                <div class="control"><input id="leaseInVat" readonly></div>
              </div>

              <!-- OWS Extra breakdown -->
              <div class="field">
                <div class="label">OWS Extra (Ex VAT) <span class="tag" data-tag></span></div>
                <div class="control"><input id="owsExtraEx" readonly></div>
              </div>
              <div class="field">
                <div class="label">VAT 7% (OWS Extra) <span class="tag" data-tag></span></div>
                <div class="control"><input id="owsExtraVat" readonly></div>
              </div>
              <div class="field">
                <div class="label">OWS Extra (In VAT) <span class="tag" data-tag></span></div>
                <div class="control"><input id="owsExtraIn" readonly></div>
              </div>

              <!-- Rates -->
              <div class="field">
                <div class="label">IRR % <span class="tag" data-tag></span></div>
                <div class="control"><input id="trRate" readonly></div>
              </div>
              <div class="field">
                <div class="label">Customer TR <span class="tag" data-tag></span></div>
                <div class="control"><input id="customerTr" readonly></div>
              </div>
            </div>
          </div>
        </section>

        <!-- OWS Information -->
        <section class="card">
          <div class="card-head"><h2>OWS Information</h2></div>
          <div class="section">
            <div class="fields">
              <div class="field"><div class="label">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏ñ <span class="tag" data-tag></span></div><div class="control"><input id="qsCarInfo" readonly></div></div>
              <div class="field"><div class="label">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ñ <span class="tag" data-tag></span></div><div class="control"><input id="qsCarPrice" readonly></div></div>
              <div class="field"><div class="label">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î <span class="tag" data-tag></span></div><div class="control"><input id="qsDiscount" readonly></div></div>
              <div class="field"><div class="label">Option <span class="tag" data-tag></span></div><div class="control"><input id="qsOption" readonly></div></div>
              <div class="field"><div class="label">‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå <span class="tag" data-tag></span></div><div class="control"><input id="qsDownAmount" readonly></div></div>
              <div class="field"><div class="label">‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå‡∏Ñ‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô % <span class="tag" data-tag></span></div><div class="control"><input id="qsDownPercent" readonly></div></div>
              <div class="field"><div class="label">‡∏ö‡∏≠‡∏•‡∏•‡∏π‡∏ô (‡∏ö‡∏≤‡∏ó) <span class="tag" data-tag></span></div><div class="control"><input id="qsBalloonAmount" readonly></div></div>
              <div class="field"><div class="label">‡∏ö‡∏≠‡∏•‡∏•‡∏π‡∏ô‡∏Ñ‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô % <span class="tag" data-tag></span></div><div class="control"><input id="qsBalloonPercent" readonly></div></div>
              <div class="field"><div class="label">IRR % <span class="tag" data-tag></span></div><div class="control"><input id="qsTrRate" readonly></div></div>
              <div class="field"><div class="label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏µ <span class="tag" data-tag></span></div><div class="control"><input id="qsTermYears" readonly></div></div>
              <div class="field"><div class="label">Deposit <span class="tag" data-tag></span></div><div class="control"><input id="qsDeposit" readonly></div></div>
              <div class="field"><div class="label">OWS Extra (Ex VAT) <span class="tag" data-tag></span></div><div class="control"><input id="qsExtraEx" readonly></div></div>
              <div class="field"><div class="label">VAT 7% (OWS Extra) <span class="tag" data-tag></span></div><div class="control"><input id="qsExtraVat" readonly></div></div>
              <div class="field"><div class="label">OWS Extra (In VAT) <span class="tag" data-tag></span></div><div class="control"><input id="qsExtraIn" readonly></div></div>
            </div>
          </div>
        </section>

        <!-- Actions -->
        <section class="card">
          <div class="card-head"><h2>‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á</h2></div>
          <div class="actions">
            <button class="btn btn-primary" onclick="calculate()">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</button>
            <button class="btn btn-danger" onclick="calculateDownForTargetLease(36000)">‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î 36,000</button>
            <button class="btn btn-ghost" onclick="generateQuotation()">‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤</button>
            <button class="btn btn-ghost" onclick="sendToQsData()">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• OWS</button>
          </div>
        </section>

      </div>
    </div>
  </main>

  <script>
    /* ========= Helpers ========= */
    function format(n, d=2){ if(isNaN(n)||n===null) return d===0?"0":(d===4?"0.0000":"0.00");
      return new Intl.NumberFormat('en-US',{minimumFractionDigits:d,maximumFractionDigits:d}).format(parseFloat(n));}
    function formatNoDecimal(n){ return format(n,0); }
    function format4(n){ return format(n,4); }
    function uncomma(s){ const c=String(s).replace(/,/g,''); const v=parseFloat(c); return isNaN(v)?0:v; }

    // IRR (per period) Newton
    function calculateIRR(nper, pmt, pv, fv=0, type=0){
      if (pmt===0 && pv===0) return NaN; if (nper<=0) return NaN;
      let rate=0.05/12, tol=1e-7, maxIter=500;
      for(let i=0;i<maxIter;i++){
        let f=pv, df=0;
        for(let t=1;t<=nper;t++){
          const adj=(type===1?1:0);
          const dfp=Math.pow(1+rate, t-adj);
          f+= pmt/dfp;
          df+= -(t-adj)*pmt/Math.pow(1+rate, t+1-adj);
        }
        f+= fv/Math.pow(1+rate, nper);
        df+= -nper*fv/Math.pow(1+rate, nper+1);
        if(Math.abs(f)<tol) return rate;
        const nr=rate - f/df;
        if(Math.abs(nr-rate)<tol) return nr;
        if(!isFinite(nr)||isNaN(nr)) return NaN;
        rate=nr;
      }
      return NaN;
    }

    // Solver for Target IRR (find Flat Rate)
    function effFromFlat(flatRatePct, inputs, smooth=true){
      const { total, down, balloon, years, months, comBase, comPercent, extra } = inputs;
      const finance = total - down;
      const base = Math.max(finance - balloon, 0);
      const intPA = base * (flatRatePct/100);
      const intTotal = intPA * years;
      const comBaseVal = (comBase === 'finance')? finance : intTotal;
      const commission = smooth ? (comBaseVal * (comPercent/100)) : Math.ceil(comBaseVal * (comPercent/100));
      let pmt = (base + intTotal) / (months || 1);
      if (!smooth) pmt = Math.ceil(pmt);
      const pv = -(finance + commission + extra); // no VAT
      const fv = balloon;
      const r = calculateIRR(months, pmt, pv, fv, 0);
      return isNaN(r)?NaN:(r*12*100);
    }
    function solveFlatForTargetIRR(target, inputs){
      let lo=0, hi=50, maxHi=200, tol=1e-4, maxIter=80;
      let elo=effFromFlat(lo,inputs,true), ehi=effFromFlat(hi,inputs,true);
      if(!isNaN(elo) && elo>=target) return 0;
      while((isNaN(ehi)||ehi<target) && hi<maxHi){ hi*=2; ehi=effFromFlat(hi,inputs,true); }
      if(isNaN(ehi)) return NaN; if(hi>=maxHi && ehi<target) return NaN;
      let best=hi, bestDiff=Math.abs(ehi-target);
      for(let i=0;i<maxIter;i++){
        const mid=(lo+hi)/2; const em=effFromFlat(mid,inputs,true); if(isNaN(em)) break;
        const diff=em-target;
        if(Math.abs(diff)<tol){ best=mid; break; }
        if(Math.abs(diff)<bestDiff){ best=mid; bestDiff=Math.abs(diff); }
        if(diff<0) lo=mid; else hi=mid;
        if(Math.abs(hi-lo)<1e-6) break;
      }
      return best;
    }

    function updateDownPctInline(){
      const total=uncomma(document.getElementById('totalAmount').value);
      const down=uncomma(document.getElementById('downAmount').value);
      const pct = total>0?(down/total*100):0;
      document.getElementById('downPercentInline').innerText = `${format4(pct)}%`;
      const q = document.getElementById('qsDownPercent'); if(q) q.value = `${format4(pct)}%`;
    }
    function updateBalloonPctInline(){
      const total=uncomma(document.getElementById('totalAmount').value);
      const bal=uncomma(document.getElementById('balloonAmount').value);
      const pct = total>0?(bal/total*100):0;
      document.getElementById('balloonPercentInline').innerText = `${format4(pct)}%`;
      const q = document.getElementById('qsBalloonPercent'); if(q) q.value = `${format4(pct)}%`;
    }

    /* ====== Core calculation ====== */
    function calculate(){
      const getVal=id=>uncomma(document.getElementById(id).value);
      const getInt=id=>parseInt(uncomma(document.getElementById(id).value))||0;

      const carInfo=document.getElementById('carInfo').value;
      const car=getVal('carPrice'), discount=getVal('discount'), option=getVal('option');
      const total=car - discount + option;
      document.getElementById('totalAmount').value = format(total);

      // Down
      const downType=document.getElementById('downType').value;
      const downInput=getVal('downInput');
      let down = (downType==='percent') ? total*(downInput/100) : downInput;
      down = Math.min(Math.max(down,0), total);
      document.getElementById('downAmount').value = format(down);

      // Balloon (<= 35% of total) ‚Äî Default mode is amount
      const typeBal=document.getElementById('balloonType').value;
      const cap=Math.max(total*0.35,0);
      let balloon=0, balPct=0;

      const pctSel=document.getElementById('balloonPercentSelect');
      const amtInp=document.getElementById('balloonManualInput');
      if(typeBal==='percent'){
        pctSel.disabled=false; amtInp.disabled=true;
        const raw = parseFloat(pctSel.value)||0;
        balPct = Math.min(Math.max(raw,0),35);
        if(raw!==balPct){ pctSel.value = String(balPct); alert('‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏ö‡∏≠‡∏•‡∏•‡∏π‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏Ñ‡∏∑‡∏≠ 35%'); }
        balloon = total*(balPct/100);
      }else{
        pctSel.disabled=true; amtInp.disabled=false;
        let manual = uncomma(amtInp.value);
        if (manual<0) manual=0;
        if (manual>cap) manual=cap;
        balloon = manual;
        balPct = total>0 ? (balloon/total*100) : 0;
        if (balPct>35) balPct=35;
      }

      document.getElementById('balloonAmount').value = format(balloon);
      updateDownPctInline();
      updateBalloonPctInline();

      const finance = total - down;
      const years=getInt('termYears'), months=years*12;

      const comBase=document.getElementById('comBase').value;
      const comPercent=getVal('comPercent');
      const extra=getVal('extra');

      // Interest mode
      const mode=document.getElementById('interestMode').value;
      let rate=getVal('interestRate');
      if(mode==='target_irr' && months>0 && total>0){
        const target= getVal('targetIrr');
        const inputs = { total, down, balloon, years, months, comBase, comPercent, extra };
        const solved = solveFlatForTargetIRR(target, inputs);
        if(!isNaN(solved)){
          rate = solved;
          document.getElementById('interestRate').value = (Math.abs(rate)<0.005) ? '0.00' : format(rate,2);
        }
      }

      if(months===0){
        ['financeAmt','intPA','intTotal','financeTotalWithInterest',
         'leaseExVat','leaseVat','leaseInVat','owsExtraEx','owsExtraVat','owsExtraIn'
        ].forEach(id=>document.getElementById(id).value = format(0));
        document.getElementById('trRate').value='‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì';
        document.getElementById('customerTr').value='‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì';
        updateOWS(carInfo, car, discount, option, down, balloon, years, NaN, 0, 0, 0);
        refreshFieldTags(); // update tags/colors
        return;
      }

      // Base & interest (flat)
      const base=Math.max(finance - balloon, 0);
      const intPA = base*(rate/100);
      const intTotal = intPA*years;
      const basePlus = base + intTotal;
      document.getElementById('financeTotalWithInterest').value = format(basePlus);

      // Commission (Ex VAT)
      const comBaseVal=(comBase==='finance')? finance : intTotal;
      const commission = Math.ceil(comBaseVal*(comPercent/100));
      document.getElementById('calculatedCommission').value = format(commission);

      // OWS Extra breakdown
      const owsEx = commission + extra;
      const owsVat = owsEx*0.07;
      const owsIn = owsEx + owsVat;
      document.getElementById('owsExtraEx').value = format(owsEx);
      document.getElementById('owsExtraVat').value = format(owsVat);
      document.getElementById('owsExtraIn').value = format(owsIn);

      // Installment
      const pmtIn = Math.ceil(basePlus / months);
      const pmtEx = pmtIn/1.07;
      const pmtVat = pmtIn - pmtEx;
      document.getElementById('leaseInVat').value = format(pmtIn);
      document.getElementById('leaseExVat').value = format(pmtEx);
      document.getElementById('leaseVat').value = format(pmtVat);

      // IRR % (pv = -(finance + commission + extra))
      const pvIRR = -(finance + commission + extra);
      const irr = calculateIRR(months, pmtIn, pvIRR, balloon, 0) * 12 * 100;

      // Customer TR (pv = -(finance))
      const pvCus = -(finance);
      const cus = calculateIRR(months, pmtIn, pvCus, balloon, 0) * 12 * 100;

      // Outputs
      document.getElementById('financeAmt').value = format(finance);
      document.getElementById('intPA').value = format(intPA);
      document.getElementById('intTotal').value = format(intTotal);
      document.getElementById('trRate').value = isNaN(irr)?'‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì':format4(irr);
      document.getElementById('customerTr').value = isNaN(cus)?'‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì':format4(cus);

      updateOWS(carInfo, car, discount, option, down, balloon, years, irr, owsEx, owsVat, owsIn);
      refreshFieldTags(); // update tags/colors
    }

    function updateOWS(carInfo, car, discount, option, down, balloon, years, irr, ex, vat, inv){
      document.getElementById('qsCarInfo').value = carInfo;
      document.getElementById('qsCarPrice').value = format(car);
      document.getElementById('qsDiscount').value = format(discount);
      document.getElementById('qsOption').value = format(option);
      document.getElementById('qsDownAmount').value = format(down);
      document.getElementById('qsTrRate').value = isNaN(irr)?'‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì':format4(irr);
      document.getElementById('qsTermYears').value = years;
      document.getElementById('qsDeposit').value = format(down/1.07,4);

      const total=uncomma(document.getElementById('totalAmount').value);
      const dPct = total>0?(down/total*100):0;
      const bPct = total>0?(balloon/total*100):0;
      document.getElementById('qsDownPercent').value = format4(dPct)+'%';
      document.getElementById('qsBalloonPercent').value = format4(bPct)+'%';
      document.getElementById('qsBalloonAmount').value = format(balloon);

      document.getElementById('qsExtraEx').value = format(ex);
      document.getElementById('qsExtraVat').value = format(vat);
      document.getElementById('qsExtraIn').value = format(inv);
    }

    function calculateDownForTargetLease(target){
      const getVal=id=>uncomma(document.getElementById(id).value);
      const getInt=id=>parseInt(uncomma(document.getElementById(id).value))||0;

      const car=getVal('carPrice'), discount=getVal('discount'), option=getVal('option');
      const total=car - discount + option;
      document.getElementById('totalAmount').value = format(total);
      const years=getInt('termYears'), months=years*12;

      // Balloon
      const typeBal=document.getElementById('balloonType').value;
      let bal=0; const cap=Math.max(total*0.35,0);
      if(typeBal==='percent'){
        const pct=Math.min(Math.max(parseFloat(document.getElementById('balloonPercentSelect').value)||0,0),35);
        bal = total*(pct/100);
      }else{
        let manual = uncomma(document.getElementById('balloonManualInput').value);
        if (manual<0) manual=0; if (manual>cap) manual=cap;
        bal=manual;
      }

      if(months===0){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏µ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); return; }

      const mode=document.getElementById('interestMode').value;
      const comBase=document.getElementById('comBase').value;
      const comPercent=getVal('comPercent'), extra=getVal('extra');
      let rate;
      if(mode==='target_irr'){
        const targetEff=getVal('targetIrr');
        if(total<=0||targetEff<0){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏ ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ ‡πÅ‡∏•‡∏∞ IRR ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); return; }
        const inputs={ total, down:0, balloon:bal, years, months, comBase, comPercent, extra };
        const solved=solveFlatForTargetIRR(targetEff, inputs);
        if(isNaN(solved)){ alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏´‡∏≤ Flat Rate ‡πÉ‡∏´‡πâ‡∏ñ‡∏∂‡∏á IRR ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢'); return; }
        rate=solved; document.getElementById('interestRate').value = format(rate,2);
      }else{
        rate=getVal('interestRate'); if(rate===0){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢'); return; }
      }

      const base0=Math.max(total - bal, 0);
      const int0 = base0*(rate/100)*years;
      const pmt0 = months>0 ? Math.ceil((base0+int0)/months) : 0;

      if(pmt0<target){
        document.getElementById('downType').value='amount';
        document.getElementById('downInput').value=formatNoDecimal(0);
        calculate();
        alert(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏±‡∏ô‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î‡∏ñ‡∏∂‡∏á ${formatNoDecimal(target)} ‡πÑ‡∏î‡πâ ‡πÅ‡∏°‡πâ‡∏î‡∏≤‡∏ß‡∏ô‡πå 0 ‡∏ö‡∏≤‡∏ó (‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î‡πÑ‡∏î‡πâ ${formatNoDecimal(pmt0)})`);
      }else{
        let lo=0, hi=total, best=0, min=Infinity;
        for(let i=0;i<500;i++){
          let d=Math.ceil((lo+hi)/2); if(d<0)d=0; if(d>total)d=total;
          const base=Math.max((total-d) - bal, 0);
          const it=base*(rate/100)*years;
          const pmt = months>0 ? Math.ceil((base+it)/months) : 0;
          const diff=Math.abs(pmt-target);
          if(diff<min){ min=diff; best=d; }
          if(Math.abs(hi-lo)<1 || diff<0.1) break;
          if(pmt>target) lo=d; else hi=d;
        }
        document.getElementById('downType').value='amount';
        document.getElementById('downInput').value=formatNoDecimal(best);
        calculate();
      }
    }

    function generateQuotation(){ calculate(); /* ‡πÄ‡∏Å‡πá‡∏ö/‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏ï‡∏≤‡∏° workflow ‡πÄ‡∏î‡∏¥‡∏° */ }
    function sendToQsData(){ calculate(); /* ‡πÄ‡∏Å‡πá‡∏ö/‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏ï‡∏≤‡∏° workflow ‡πÄ‡∏î‡∏¥‡∏° */ }

    /* ===== Input wiring & Tag refresh ===== */
    function addNumericListeners(id){
      const el=document.getElementById(id); if(!el) return;
      el.addEventListener('focus', ()=>{ let v=uncomma(el.value); el.value=(Math.abs(v)<0.001)?'':String(v); });
      el.addEventListener('input', ()=>{
        let s=el.value.replace(/[^0-9.]/g,'');
        const parts=s.split('.'); if(parts.length>2) s=parts[0]+'.'+parts.slice(1).join('');
        el.value=s;
      });
      el.addEventListener('blur', ()=>{
        let v=uncomma(el.value);
        if(id==='termYears') el.value=formatNoDecimal(v);
        else if(['interestRate','comPercent','targetIrr'].includes(id)) el.value=format(v,2);
        else el.value=format(v);
        calculate();
      });
    }

    function toggleBalloonUI(){
      const type=document.getElementById('balloonType').value;
      const pctSel=document.getElementById('balloonPercentSelect');
      const amtInp=document.getElementById('balloonManualInput');
      if(type==='percent'){
        pctSel.disabled=false;  amtInp.disabled=true;
      }else{
        pctSel.disabled=true;   amtInp.disabled=false;
      }
      refreshFieldTags();
    }

    function toggleInterestMode(){
      const mode=document.getElementById('interestMode').value;
      const flat=document.getElementById('interestRate');
      const irr=document.getElementById('targetIrr');
      if(mode==='flat'){ flat.disabled=false; irr.disabled=true; }
      else{ flat.disabled=true; irr.disabled=false; }
      refreshFieldTags();
    }

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á/‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ó‡πá‡∏Å‡∏ö‡∏ô label ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ/‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì)
    function refreshFieldTags(){
      document.querySelectorAll('.field').forEach(field=>{
        const label = field.querySelector('.label [data-tag]') || field.querySelector('.label .tag[data-tag]');
        const ctrl  = field.querySelector('.control input, .control select');
        if(!label || !ctrl) return;

        const isEditable = (
          (ctrl.tagName==='INPUT' && !ctrl.readOnly && !ctrl.disabled) ||
          (ctrl.tagName==='SELECT' && !ctrl.disabled)
        );

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ó‡πá‡∏Å‡∏´‡∏≤‡∏Å‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
        if(!label.classList.contains('tag')){
          label.classList.add('tag');
        }

        if(isEditable){
          label.classList.remove('tag-ro'); label.classList.add('tag-edit');
          label.textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ';
        }else{
          label.classList.remove('tag-edit'); label.classList.add('tag-ro');
          label.textContent = '‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì';
        }
      });
    }

    window.onload = ()=>{
      // Numeric inputs
      ['carPrice','discount','option','downInput','interestRate','extra','termYears','comPercent','balloonManualInput','targetIrr']
        .forEach(addNumericListeners);

      // Selects
      document.getElementById('downType').addEventListener('change', calculate);
      document.getElementById('comBase').addEventListener('change', calculate);
      document.getElementById('balloonType').addEventListener('change', ()=>{ toggleBalloonUI(); calculate(); });
      document.getElementById('balloonPercentSelect').addEventListener('change', calculate);
      document.getElementById('interestMode').addEventListener('change', ()=>{ toggleInterestMode(); calculate(); });

      // Defaults: Balloon = amount, value=0
      document.getElementById('balloonType').value = 'amount';
      document.getElementById('balloonManualInput').value = '0.00';

      toggleBalloonUI();
      toggleInterestMode();
      calculate();
      refreshFieldTags();
    };
  </script>
</body>
</html>
