<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>ORIX Financial Lease Calculator — Split Sections</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Google Font: Noto Sans Thai -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      /* ORIX Minimal palette */
      --orix-blue: #003366;
      --blue-600: #0A3B6F;
      --blue-050: #F6FAFD;

      --ink-900: #12161C;
      --ink-700: #2E3A46;
      --ink-600: #475569;
      --ink-500: #64748B;
      --line: #E6EBF0;
      --white: #FFFFFF;

      /* Inputs (แยกชัดเจน) */
      --editable-bg: #FFFDF0;       /* very light yellow */
      --editable-border: #F3E6BA;
      --readonly-bg: #EAF4FF;       /* light blue */
      --readonly-border: #BBD8FF;
      --readonly-text: #0B3A6A;

      --input-radius: 12px;
      --ring: rgba(0, 51, 102, 0.25);
      --shadow: 0 8px 24px rgba(18, 22, 28, 0.06);
      --radius: 12px;
    }

    * { box-sizing: border-box; }
    body {
      font-family: 'Noto Sans Thai', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      font-weight: 300;
      margin: 0;
      color: var(--ink-700);
      background: linear-gradient(180deg, var(--blue-050), #fff 200px);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Header */
    header {
      background: var(--white);
      border-bottom: 1px solid var(--line);
      position: sticky;
      top: 0; z-index: 10;
    }
    .nav {
      max-width: 1100px;
      margin: 0 auto;
      padding: 14px 16px;
      display: flex; gap: 10px; align-items: center;
    }
    .brand { width: 8px; height: 26px; border-radius: 4px; background: var(--orix-blue); }
    .title { font-size: 18px; font-weight: 600; color: var(--ink-900); letter-spacing: .1px; }

    /* Container */
    main { max-width: 1100px; margin: 8px auto 28px; padding: 0 16px; }

    /* Global Legend */
    .legend-global {
      max-width: 1100px;
      margin: 8px auto 0;
      padding: 8px 16px;
      display: flex; gap: 14px; flex-wrap: wrap; align-items: center;
      font-size: 12px; color: var(--ink-600);
    }
    .legend-item { display: inline-flex; align-items: center; gap: 8px; }
    .legend-box {
      width: 14px; height: 14px; border-radius: 4px; display: inline-block; border: 1px solid var(--line);
    }

    /* Card */
    .card {
      background: var(--white);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    .card + .card { margin-top: 14px; }
    .card-head {
      padding: 12px 14px;
      border-bottom: 1px solid var(--line);
      display: flex; align-items: center; gap: 10px; justify-content: space-between;
    }
    .card-head h2 {
      margin: 0; font-size: 14px; font-weight: 600; color: var(--orix-blue); letter-spacing: .2px;
    }

    /* Rows */
    .row { display: grid; grid-template-columns: 1fr; gap: 14px; margin-top: 14px; }
    .row.two { grid-template-columns: 1fr; }
    @media (min-width: 900px) {
      .row.two { grid-template-columns: 1fr 1fr; }
    }

    /* Section + Fields */
    .section { border-radius: 10px; overflow: hidden; border: 1px solid var(--line); }
    .fields { display: grid; grid-template-columns: 1fr; }
    @media (min-width: 640px) { .fields { grid-template-columns: 1fr 1fr; } }

    .field {
      display: grid; grid-template-columns: 46% 54%;
      align-items: center; gap: 10px; padding: 10px 12px;
      border-bottom: 1px solid var(--line); background: #fff;
    }
    .field:nth-child(even) { background: #FCFEFF; }
    .field:last-child { border-bottom: none; }

    .label {
      font-size: 13px; color: var(--ink-600);
      display: flex; align-items: center; gap: 6px; flex-wrap: wrap;
      font-weight: 400;
    }
    .muted { color: var(--ink-500); font-size: 12px; }

    /* Inputs */
    .control input:not([readonly]), .control select {
      width: 100%; padding: 10px 12px;
      border: 1px solid var(--editable-border);
      border-radius: var(--input-radius);
      background: var(--editable-bg);
      color: var(--ink-700);
      text-align: right; font-weight: 400;
      outline: none; transition: .15s ease;
    }
    .control input#carInfo { text-align: left; }
    .control input:focus, .control select:focus {
      border-color: var(--orix-blue); box-shadow: 0 0 0 3px var(--ring); background: #fff;
    }
    .control input[readonly],
    .control select:disabled,
    .control input:disabled {
      background: var(--readonly-bg);
      border: 1px solid var(--readonly-border);
      color: var(--readonly-text);
      cursor: not-allowed;
      font-weight: 600;
      border-radius: var(--input-radius);
    }

    /* Actions */
    .actions { display: grid; gap: 10px; padding: 12px; grid-template-columns: 1fr 1fr; }
    @media (min-width: 680px) { .actions { grid-template-columns: repeat(4, 1fr); } }
    .btn {
      padding: 12px 14px; border: 1px solid transparent; border-radius: 10px;
      font-weight: 600; font-size: 14px; cursor: pointer; transition: .12s ease;
    }
    .btn:active { transform: scale(.99); }
    .btn-primary { background: var(--orix-blue); color: #fff; }
    .btn-primary:hover { background: var(--blue-600); }
    .btn-ghost { background: #fff; border-color: var(--line); color: var(--ink-700); }
    .btn-ghost:hover { border-color: var(--orix-blue); color: var(--orix-blue); }
    .btn-danger { background: #E30613; color: #fff; }
    .btn-danger:hover { background: #B0050D; }
  </style>
</head>
<body>
  <header>
    <div class="nav">
      <span class="brand"></span>
      <div class="title">ORIX Financial Lease Calculator</div>
    </div>
  </header>

  <!-- Legend บนสุด (จุดเดียว) -->
  <div class="legend-global">
    <span class="legend-item">
      <span class="legend-box" style="background:#FFFDF0;border-color:#F3E6BA;"></span>
      ช่องกรอกได้ (Editable)
    </span>
    <span class="legend-item">
      <span class="legend-box" style="background:#EAF4FF;border-color:#BBD8FF;"></span>
      คำนวณอัตโนมัติ / ห้ามแก้ไข
    </span>
  </div>

  <main>

    <!-- Row 1: ข้อมูลเบื้องต้น (เต็มความกว้าง) -->
    <div class="row">
      <section class="card">
        <div class="card-head"><h2>ข้อมูลเบื้องต้น</h2></div>
        <div class="section">
          <div class="fields">
            <div class="field">
              <div class="label">ข้อมูลรถ</div>
              <div class="control"><input id="carInfo" type="text" value=""></div>
            </div>
            <div class="field">
              <div class="label">ราคารถ</div>
              <div class="control"><input id="carPrice" type="text" value="0.00"></div>
            </div>
            <div class="field">
              <div class="label">ส่วนลด</div>
              <div class="control"><input id="discount" type="text" value="0.00"></div>
            </div>
            <div class="field">
              <div class="label">Option</div>
              <div class="control"><input id="option" type="text" value="0.00"></div>
            </div>
            <div class="field">
              <div class="label">ราคาสุทธิ</div>
              <div class="control"><input id="totalAmount" readonly></div>
            </div>
          </div>
        </div>
      </section>
    </div>

    <!-- Row 2: ซ้าย = เงินดาวน์ | บอลลูน  |  ขวา = ดอกเบี้ย | ค่าคอม -->
    <div class="row two">

      <!-- ซ้าย: เงินดาวน์ | บอลลูน -->
      <section class="card">
        <div class="card-head"><h2>เงินดาวน์ | บอลลูน</h2></div>
        <div class="section">
          <div class="fields">
            <div class="field">
              <div class="label">รูปแบบดาวน์</div>
              <div class="control">
                <select id="downType">
                  <option value="percent">เป็น %</option>
                  <option value="amount">เป็นจำนวนเงิน</option>
                </select>
              </div>
            </div>
            <div class="field">
              <div class="label">กรอก % หรือ จำนวน</div>
              <div class="control"><input id="downInput" type="text" value="0.00"></div>
            </div>
            <div class="field">
              <div class="label">เงินดาวน์ <span class="muted">( <span id="downPercentInline">0.0000%</span> )</span></div>
              <div class="control"><input id="downAmount" readonly></div>
            </div>

            <div class="field">
              <div class="label">รูปแบบบอลลูน</div>
              <div class="control">
                <select id="balloonType">
                  <!-- Default = amount -->
                  <option value="amount" selected>ระบุเป็นจำนวนเงิน</option>
                  <option value="percent">เป็น % ของราคาสุทธิ</option>
                </select>
              </div>
            </div>
            <div class="field">
              <div class="label">เปอร์เซ็นต์บอลลูน</div>
              <div class="control">
                <select id="balloonPercentSelect" disabled>
                  <option value="5">5%</option>
                  <option value="10" selected>10%</option>
                  <option value="15">15%</option>
                  <option value="20">20%</option>
                  <option value="25">25%</option>
                  <option value="30">30%</option>
                  <option value="35">35% (สูงสุด)</option>
                </select>
              </div>
            </div>
            <div class="field">
              <div class="label">จำนวนเงินบอลลูน</div>
              <div class="control"><input id="balloonManualInput" type="text" value="0.00"></div>
            </div>
            <div class="field">
              <div class="label">ยอดบอลลูน <span class="muted">( <span id="balloonPercentInline">0.0000%</span> )</span></div>
              <div class="control"><input id="balloonAmount" readonly></div>
            </div>
          </div>
        </div>
      </section>

      <!-- ขวา: ดอกเบี้ย | ค่าคอม -->
      <section class="card">
        <div class="card-head"><h2>ดอกเบี้ย | ค่าคอม</h2></div>
        <div class="section">
          <div class="fields">
            <div class="field">
              <div class="label">โหมดดอกเบี้ย</div>
              <div class="control">
                <select id="interestMode">
                  <option value="flat" selected>กำหนด Flat Rate (%)</option>
                  <option value="target_irr">กำหนด IRR เป้าหมาย (% ต่อปี)</option>
                </select>
              </div>
            </div>
            <div class="field">
              <div class="label">Flat Rate (%)</div>
              <div class="control"><input id="interestRate" type="text" value="0.00"></div>
            </div>
            <div class="field">
              <div class="label">IRR เป้าหมาย (% ต่อปี)</div>
              <div class="control"><input id="targetIrr" type="text" value="0.00" disabled></div>
            </div>
            <div class="field">
              <div class="label">จำนวนปี</div>
              <div class="control"><input id="termYears" type="number" step="1" value="0"></div>
            </div>

            <div class="field">
              <div class="label">คิดค่าคอมจาก</div>
              <div class="control">
                <select id="comBase">
                  <option value="interest">ดอกเบี้ยรวม</option>
                  <option value="finance">ยอดจัด</option>
                </select>
              </div>
            </div>
            <div class="field">
              <div class="label">Commission (%)</div>
              <div class="control"><input id="comPercent" type="text" value="0.00"></div>
            </div>
            <div class="field">
              <div class="label">ค่าคอม (Ex VAT)</div>
              <div class="control"><input id="calculatedCommission" readonly></div>
            </div>
            <div class="field">
              <div class="label">Extra Commission (Ex VAT)</div>
              <div class="control"><input id="extra" type="text" value="0.00"></div>
            </div>
          </div>
        </div>
      </section>

    </div>

    <!-- Row 3: ซ้าย = ผลลัพธ์ | ขวา = OWS -->
    <div class="row two">

      <!-- ผลลัพธ์ -->
      <section class="card">
        <div class="card-head"><h2>ผลลัพธ์</h2></div>
        <div class="section">
          <div class="fields">
            <div class="field">
              <div class="label">ยอดจัด</div>
              <div class="control"><input id="financeAmt" readonly></div>
            </div>
            <div class="field">
              <div class="label">ดอกเบี้ยต่อปี (Ex VAT)</div>
              <div class="control"><input id="intPA" readonly></div>
            </div>
            <div class="field">
              <div class="label">ดอกเบี้ยรวม (Ex VAT)</div>
              <div class="control"><input id="intTotal" readonly></div>
            </div>
            <div class="field">
              <div class="label">ยอดจัดรวม (ฐานผ่อน)</div>
              <div class="control"><input id="financeTotalWithInterest" readonly></div>
            </div>

            <div class="field">
              <div class="label">ค่างวด (Ex VAT) / งวด</div>
              <div class="control"><input id="leaseExVat" readonly></div>
            </div>
            <div class="field">
              <div class="label">VAT 7% / งวด</div>
              <div class="control"><input id="leaseVat" readonly></div>
            </div>
            <div class="field">
              <div class="label">ค่างวด (In VAT) / งวด</div>
              <div class="control"><input id="leaseInVat" readonly></div>
            </div>

            <div class="field">
              <div class="label">OWS Extra (Ex VAT)</div>
              <div class="control"><input id="owsExtraEx" readonly></div>
            </div>
            <div class="field">
              <div class="label">VAT 7% (OWS Extra)</div>
              <div class="control"><input id="owsExtraVat" readonly></div>
            </div>
            <div class="field">
              <div class="label">OWS Extra (In VAT)</div>
              <div class="control"><input id="owsExtraIn" readonly></div>
            </div>

            <div class="field">
              <div class="label">IRR %</div>
              <div class="control"><input id="trRate" readonly></div>
            </div>
            <div class="field">
              <div class="label">Customer TR</div>
              <div class="control"><input id="customerTr" readonly></div>
            </div>
          </div>
        </div>
      </section>

      <!-- OWS Information -->
      <section class="card">
        <div class="card-head"><h2>OWS Information</h2></div>
        <div class="section">
          <div class="fields">
            <div class="field"><div class="label">ข้อมูลรถ</div><div class="control"><input id="qsCarInfo" readonly></div></div>
            <div class="field"><div class="label">ราคารถ</div><div class="control"><input id="qsCarPrice" readonly></div></div>
            <div class="field"><div class="label">ส่วนลด</div><div class="control"><input id="qsDiscount" readonly></div></div>
            <div class="field"><div class="label">Option</div><div class="control"><input id="qsOption" readonly></div></div>
            <div class="field"><div class="label">เงินดาวน์</div><div class="control"><input id="qsDownAmount" readonly></div></div>
            <div class="field"><div class="label">เงินดาวน์คิดเป็น %</div><div class="control"><input id="qsDownPercent" readonly></div></div>
            <div class="field"><div class="label">บอลลูน (บาท)</div><div class="control"><input id="qsBalloonAmount" readonly></div></div>
            <div class="field"><div class="label">บอลลูนคิดเป็น %</div><div class="control"><input id="qsBalloonPercent" readonly></div></div>
            <div class="field"><div class="label">IRR %</div><div class="control"><input id="qsTrRate" readonly></div></div>
            <div class="field"><div class="label">จำนวนปี</div><div class="control"><input id="qsTermYears" readonly></div></div>
            <div class="field"><div class="label">Deposit</div><div class="control"><input id="qsDeposit" readonly></div></div>
            <div class="field"><div class="label">OWS Extra (Ex VAT)</div><div class="control"><input id="qsExtraEx" readonly></div></div>
            <div class="field"><div class="label">VAT 7% (OWS Extra)</div><div class="control"><input id="qsExtraVat" readonly></div></div>
            <div class="field"><div class="label">OWS Extra (In VAT)</div><div class="control"><input id="qsExtraIn" readonly></div></div>
          </div>
        </div>
      </section>

    </div>

    <!-- Row 4: Actions (เต็มความกว้าง) -->
    <div class="row">
      <section class="card">
        <div class="card-head"><h2>คำสั่ง</h2></div>
        <div class="actions">
          <button class="btn btn-primary" onclick="calculate()">คำนวณ</button>
          <button class="btn btn-danger" onclick="calculateDownForTargetLease(36000)">ค่างวด 36,000</button>
          <button class="btn btn-ghost" onclick="generateQuotation()">ใบเสนอราคา</button>
          <button class="btn btn-ghost" onclick="sendToQsData()">ส่งข้อมูล OWS</button>
        </div>
      </section>
    </div>

  </main>

  <script>
    /* ========= Helpers ========= */
    function format(n, d=2){ if(isNaN(n)||n===null) return d===0?"0":(d===4?"0.0000":"0.00");
      return new Intl.NumberFormat('en-US',{minimumFractionDigits:d,maximumFractionDigits:d}).format(parseFloat(n));}
    function formatNoDecimal(n){ return format(n,0); }
    function format4(n){ return format(n,4); }
    function uncomma(s){ const c=String(s).replace(/,/g,''); const v=parseFloat(c); return isNaN(v)?0:v; }

    // IRR per period (Newton)
    function calculateIRR(nper, pmt, pv, fv=0, type=0){
      if (pmt===0 && pv===0) return NaN; if (nper<=0) return NaN;
      let rate=0.05/12, tol=1e-7, maxIter=500;
      for(let i=0;i<maxIter;i++){
        let f=pv, df=0;
        for(let t=1;t<=nper;t++){
          const adj=(type===1?1:0);
          const dfp=Math.pow(1+rate, t-adj);
          f+= pmt/dfp;
          df+= -(t-adj)*pmt/Math.pow(1+rate, t+1-adj);
        }
        f+= fv/Math.pow(1+rate, nper);
        df+= -nper*fv/Math.pow(1+rate, nper+1);
        if(Math.abs(f)<tol) return rate;
        const nr=rate - f/df;
        if(Math.abs(nr-rate)<tol) return nr;
        if(!isFinite(nr)||isNaN(nr)) return NaN;
        rate=nr;
      }
      return NaN;
    }

    // Target IRR Solver (Flat Rate)
    function effFromFlat(flatRatePct, inputs, smooth=true){
      const { total, down, balloon, years, months, comBase, comPercent, extra } = inputs;
      const finance = total - down;
      const base = Math.max(finance - balloon, 0);
      const intPA = base * (flatRatePct/100);
      const intTotal = intPA * years;
      const comBaseVal = (comBase === 'finance')? finance : intTotal;
      const commission = smooth ? (comBaseVal * (comPercent/100)) : Math.ceil(comBaseVal * (comPercent/100));
      let pmt = (base + intTotal) / (months || 1);
      if (!smooth) pmt = Math.ceil(pmt);
      const pv = -(finance + commission + extra); // no VAT
      const fv = balloon;
      const r = calculateIRR(months, pmt, pv, fv, 0);
      return isNaN(r)?NaN:(r*12*100);
    }
    function solveFlatForTargetIRR(target, inputs){
      let lo=0, hi=50, maxHi=200, tol=1e-4, maxIter=80;
      let elo=effFromFlat(lo,inputs,true), ehi=effFromFlat(hi,inputs,true);
      if(!isNaN(elo) && elo>=target) return 0;
      while((isNaN(ehi)||ehi<target) && hi<maxHi){ hi*=2; ehi=effFromFlat(hi,inputs,true); }
      if(isNaN(ehi)) return NaN; if(hi>=maxHi && ehi<target) return NaN;
      let best=hi, bestDiff=Math.abs(ehi-target);
      for(let i=0;i<maxIter;i++){
        const mid=(lo+hi)/2; const em=effFromFlat(mid,inputs,true); if(isNaN(em)) break;
        const diff=em-target;
        if(Math.abs(diff)<tol){ best=mid; break; }
        if(Math.abs(diff)<bestDiff){ best=mid; bestDiff=Math.abs(diff); }
        if(diff<0) lo=mid; else hi=mid;
        if(Math.abs(hi-lo)<1e-6) break;
      }
      return best;
    }

    function updateDownPctInline(){
      const total=uncomma(document.getElementById('totalAmount').value);
      const down=uncomma(document.getElementById('downAmount').value);
      const pct = total>0?(down/total*100):0;
      document.getElementById('downPercentInline').innerText = `${format4(pct)}%`;
      const q = document.getElementById('qsDownPercent'); if(q) q.value = `${format4(pct)}%`;
    }
    function updateBalloonPctInline(){
      const total=uncomma(document.getElementById('totalAmount').value);
      const bal=uncomma(document.getElementById('balloonAmount').value);
      const pct = total>0?(bal/total*100):0;
      document.getElementById('balloonPercentInline').innerText = `${format4(pct)}%`;
      const q = document.getElementById('qsBalloonPercent'); if(q) q.value = `${format4(pct)}%`;
    }

    // ========= Core calc =========
    function calculate(){
      const getVal=id=>uncomma(document.getElementById(id).value);
      const getInt=id=>parseInt(uncomma(document.getElementById(id).value))||0;

      const carInfo=document.getElementById('carInfo').value;
      const car=getVal('carPrice'), discount=getVal('discount'), option=getVal('option');
      const total=car - discount + option;
      document.getElementById('totalAmount').value = format(total);

      // Down
      const downType=document.getElementById('downType').value;
      const downInput=getVal('downInput');
      let down = (downType==='percent') ? total*(downInput/100) : downInput;
      down = Math.min(Math.max(down,0), total);
      document.getElementById('downAmount').value = format(down);

      // Balloon (≤ 35% of total) — Default mode is amount
      const typeBal=document.getElementById('balloonType').value;
      const cap=Math.max(total*0.35,0);
      let balloon=0, balPct=0;

      const pctSel=document.getElementById('balloonPercentSelect');
      const amtInp=document.getElementById('balloonManualInput');
      if(typeBal==='percent'){
        pctSel.disabled=false;  amtInp.disabled=true;
        const raw = parseFloat(pctSel.value)||0;
        balPct = Math.min(Math.max(raw,0),35);
        if(raw!==balPct){
          pctSel.value = String(balPct);
          alert('เปอร์เซ็นต์บอลลูนสูงสุดคือ 35%');
        }
        balloon = total*(balPct/100);
      }else{
        pctSel.disabled=true;   amtInp.disabled=false;
        let manual = uncomma(amtInp.value);
        if (manual<0) manual=0;
        if (manual>cap) manual=cap;
        balloon = manual;
        balPct = total>0 ? (balloon/total*100) : 0;
        if (balPct>35) balPct=35;
      }

      document.getElementById('balloonAmount').value = format(balloon);
      updateDownPctInline();
      updateBalloonPctInline();

      const finance = total - down;
      const years=getInt('termYears'), months=years*12;

      const comBase=document.getElementById('comBase').value;
      const comPercent=getVal('comPercent');
      const extra=getVal('extra');

      // Interest mode
      const mode=document.getElementById('interestMode').value;
      let rate=getVal('interestRate');
      if(mode==='target_irr' && months>0 && total>0){
        const target= getVal('targetIrr');
        const inputs = { total, down, balloon, years, months, comBase, comPercent, extra };
        const solved = solveFlatForTargetIRR(target, inputs);
        if(!isNaN(solved)){
          rate = solved;
          document.getElementById('interestRate').value = (Math.abs(rate)<0.005) ? '0.00' : format(rate,2);
        }
      }

      if(months===0){
        ['financeAmt','intPA','intTotal','financeTotalWithInterest',
         'leaseExVat','leaseVat','leaseInVat','owsExtraEx','owsExtraVat','owsExtraIn'
        ].forEach(id=>document.getElementById(id).value = format(0));
        document.getElementById('trRate').value='ไม่สามารถคำนวณ';
        document.getElementById('customerTr').value='ไม่สามารถคำนวณ';
        updateOWS(carInfo, car, discount, option, down, balloon, years, NaN, 0, 0, 0);
        return;
      }

      // Base & interest (flat)
      const base=Math.max(finance - balloon, 0);
      const intPA = base*(rate/100);
      const intTotal = intPA*years;
      const basePlus = base + intTotal;
      document.getElementById('financeTotalWithInterest').value = format(basePlus);

      // Commission (Ex VAT)
      const comBaseVal=(comBase==='finance')? finance : intTotal;
      const commission = Math.ceil(comBaseVal*(comPercent/100));
      document.getElementById('calculatedCommission').value = format(commission);

      // OWS Extra breakdown
      const owsEx = commission + extra;
      const owsVat = owsEx*0.07;
      const owsIn = owsEx + owsVat;
      document.getElementById('owsExtraEx').value = format(owsEx);
      document.getElementById('owsExtraVat').value = format(owsVat);
      document.getElementById('owsExtraIn').value = format(owsIn);

      // Installment
      const pmtIn = Math.ceil(basePlus / months);
      const pmtEx = pmtIn/1.07;
      const pmtVat = pmtIn - pmtEx;
      document.getElementById('leaseInVat').value = format(pmtIn);
      document.getElementById('leaseExVat').value = format(pmtEx);
      document.getElementById('leaseVat').value = format(pmtVat);

      // IRR % (pv = -(finance + commission + extra))
      const pvIRR = -(finance + commission + extra);
      const irr = calculateIRR(months, pmtIn, pvIRR, balloon, 0) * 12 * 100;

      // Customer TR (pv = -(finance))
      const pvCus = -(finance);
      const cus = calculateIRR(months, pmtIn, pvCus, balloon, 0) * 12 * 100;

      // Outputs
      document.getElementById('financeAmt').value = format(finance);
      document.getElementById('intPA').value = format(intPA);
      document.getElementById('intTotal').value = format(intTotal);
      document.getElementById('trRate').value = isNaN(irr)?'ไม่สามารถคำนวณ':format4(irr);
      document.getElementById('customerTr').value = isNaN(cus)?'ไม่สามารถคำนวณ':format4(cus);

      updateOWS(carInfo, car, discount, option, down, balloon, years, irr, owsEx, owsVat, owsIn);
    }

    function updateOWS(carInfo, car, discount, option, down, balloon, years, irr, ex, vat, inv){
      document.getElementById('qsCarInfo').value = carInfo;
      document.getElementById('qsCarPrice').value = format(car);
      document.getElementById('qsDiscount').value = format(discount);
      document.getElementById('qsOption').value = format(option);
      document.getElementById('qsDownAmount').value = format(down);
      document.getElementById('qsTrRate').value = isNaN(irr)?'ไม่สามารถคำนวณ':format4(irr);
      document.getElementById('qsTermYears').value = years;
      document.getElementById('qsDeposit').value = format(down/1.07,4);

      const total=uncomma(document.getElementById('totalAmount').value);
      const dPct = total>0?(down/total*100):0;
      const bPct = total>0?(balloon/total*100):0;
      document.getElementById('qsDownPercent').value = format4(dPct)+'%';
      document.getElementById('qsBalloonPercent').value = format4(bPct)+'%';
      document.getElementById('qsBalloonAmount').value = format(balloon);

      document.getElementById('qsExtraEx').value = format(ex);
      document.getElementById('qsExtraVat').value = format(vat);
      document.getElementById('qsExtraIn').value = format(inv);
    }

    function calculateDownForTargetLease(target){
      const getVal=id=>uncomma(document.getElementById(id).value);
      const getInt=id=>parseInt(uncomma(document.getElementById(id).value))||0;

      const car=getVal('carPrice'), discount=getVal('discount'), option=getVal('option');
      const total=car - discount + option;
      document.getElementById('totalAmount').value = format(total);
      const years=getInt('termYears'), months=years*12;

      // Balloon
      const typeBal=document.getElementById('balloonType').value;
      let bal=0; const cap=Math.max(total*0.35,0);
      if(typeBal==='percent'){
        const pct=Math.min(Math.max(parseFloat(document.getElementById('balloonPercentSelect').value)||0,0),35);
        bal = total*(pct/100);
      }else{
        let manual = uncomma(document.getElementById('balloonManualInput').value);
        if (manual<0) manual=0; if (manual>cap) manual=cap;
        bal=manual;
      }

      if(months===0){ alert('กรุณาระบุจำนวนปีให้ถูกต้อง'); return; }

      const mode=document.getElementById('interestMode').value;
      const comBase=document.getElementById('comBase').value;
      const comPercent=getVal('comPercent'), extra=getVal('extra');
      let rate;
      if(mode==='target_irr'){
        const targetEff=getVal('targetIrr');
        if(total<=0||targetEff<0){ alert('กรุณาระบุ ราคาสุทธิ และ IRR เป้าหมาย ให้ถูกต้อง'); return; }
        const inputs={ total, down:0, balloon:bal, years, months, comBase, comPercent, extra };
        const solved=solveFlatForTargetIRR(targetEff, inputs);
        if(isNaN(solved)){ alert('ไม่สามารถหา Flat Rate ให้ถึง IRR เป้าหมาย'); return; }
        rate=solved; document.getElementById('interestRate').value = format(rate,2);
      }else{
        rate=getVal('interestRate'); if(rate===0){ alert('กรุณาระบุอัตราดอกเบี้ย'); return; }
      }

      const base0=Math.max(total - bal, 0);
      const int0 = base0*(rate/100)*years;
      const pmt0 = months>0 ? Math.ceil((base0+int0)/months) : 0;

      if(pmt0<target){
        document.getElementById('downType').value='amount';
        document.getElementById('downInput').value=formatNoDecimal(0);
        calculate();
        alert(`ไม่สามารถดันค่างวดถึง ${formatNoDecimal(target)} ได้ แม้ดาวน์ 0 บาท (ค่างวดได้ ${formatNoDecimal(pmt0)})`);
      }else{
        let lo=0, hi=total, best=0, min=Infinity;
        for(let i=0;i<500;i++){
          let d=Math.ceil((lo+hi)/2); if(d<0)d=0; if(d>total)d=total;
          const base=Math.max((total-d) - bal, 0);
          const it=base*(rate/100)*years;
          const pmt = months>0 ? Math.ceil((base+it)/months) : 0;
          const diff=Math.abs(pmt-target);
          if(diff<min){ min=diff; best=d; }
          if(Math.abs(hi-lo)<1 || diff<0.1) break;
          if(pmt>target) lo=d; else hi=d;
        }
        document.getElementById('downType').value='amount';
        document.getElementById('downInput').value=formatNoDecimal(best);
        calculate();
      }
    }

    function generateQuotation(){ calculate(); /* เก็บ/เปิดหน้าถัดไปตาม workflow ของคุณ */ }
    function sendToQsData(){ calculate(); /* เก็บ/เปิดหน้าถัดไปตาม workflow ของคุณ */ }

    // ========= UI wiring =========
    function addNumericListeners(id){
      const el=document.getElementById(id); if(!el) return;
      el.addEventListener('focus', ()=>{ let v=uncomma(el.value); el.value=(Math.abs(v)<0.001)?'':String(v); });
      el.addEventListener('input', ()=>{
        let s=el.value.replace(/[^0-9.]/g,'');
        const parts=s.split('.'); if(parts.length>2) s=parts[0]+'.'+parts.slice(1).join('');
        el.value=s;
      });
      el.addEventListener('blur', ()=>{
        let v=uncomma(el.value);
        if(id==='termYears') el.value=formatNoDecimal(v);
        else if(['interestRate','comPercent','targetIrr'].includes(id)) el.value=format(v,2);
        else el.value=format(v);
        calculate();
      });
    }
    function toggleBalloonUI(){
      const type=document.getElementById('balloonType').value;
      const pctSel=document.getElementById('balloonPercentSelect');
      const amtInp=document.getElementById('balloonManualInput');
      if(type==='percent'){ pctSel.disabled=false;  amtInp.disabled=true; }
      else{                pctSel.disabled=true;   amtInp.disabled=false; }
    }
    function toggleInterestMode(){
      const mode=document.getElementById('interestMode').value;
      const flat=document.getElementById('interestRate');
      const irr=document.getElementById('targetIrr');
      if(mode==='flat'){ flat.disabled=false; irr.disabled=true; }
      else{             flat.disabled=true;  irr.disabled=false; }
    }

    window.onload = ()=>{
      ['carPrice','discount','option','downInput','interestRate','extra','termYears','comPercent','balloonManualInput','targetIrr']
        .forEach(addNumericListeners);

      document.getElementById('downType').addEventListener('change', calculate);
      document.getElementById('comBase').addEventListener('change', calculate);
      document.getElementById('balloonType').addEventListener('change', ()=>{ toggleBalloonUI(); calculate(); });
      document.getElementById('balloonPercentSelect').addEventListener('change', calculate);
      document.getElementById('interestMode').addEventListener('change', ()=>{ toggleInterestMode(); calculate(); });

      // Default: Balloon = amount, 0.00
      document.getElementById('balloonType').value = 'amount';
      document.getElementById('balloonManualInput').value = '0.00';

      toggleBalloonUI();
      toggleInterestMode();
      calculate();
    };
  </script>
</body>
</html>
