<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>ORIX Financial Lease Calculator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      /* ORIX Logo Colors */
      --orix-logo-blue: #003366; 
      --orix-logo-red: #E30613;  
      /* General UI Colors */
      --orix-white: #FFFFFF;
      --orix-light-grey: #F0F5F8; 
      --orix-dark-grey: #333333;
      --orix-border-color: #B0C4D4; 
      --input-bg-editable: #FFFFF0; 
      --input-bg-readonly: #EAEFF3; 
      --highlight-text-color: var(--orix-logo-blue); 
    }

    body {
      font-family: 'Kanit', sans-serif;
      margin: 0; 
      padding: 2px; /* ลด padding รอบนอกให้เหลือแค่ 2px */
      background: var(--orix-light-grey);
      color: var(--orix-dark-grey);
      line-height: 1.4; /* ลด line-height */
      font-size: 0.9em; /* ลดขนาดฟอนต์เริ่มต้น */
    }

    .container {
      width: 100%; 
      margin: 5px auto; /* ลด margin บน/ล่าง */
      background: var(--orix-white);
      padding: 10px; /* ลด padding ภายใน */
      border-radius: 6px; /* ลดความโค้งมน */
      box-shadow: 0 3px 10px rgba(0, 51, 102, 0.1); /* ลดขนาดเงา */
      transition: box-shadow 0.3s ease;
      box-sizing: border-box; 
    }
    
    .container:hover {
        box-shadow: 0 5px 15px rgba(0, 51, 102, 0.15);
    }

    h1 {
      text-align: center;
      color: var(--orix-logo-blue);
      margin-bottom: 15px; /* ลด margin */
      font-size: 1.5em; /* ลดขนาด H1 */
      font-weight: 700;
    }

    h2 {
      margin-top: 15px; 
      margin-bottom: 5px; /* ลด margin */
      color: var(--orix-logo-blue);
      font-size: 1.2em; /* ลดขนาด H2 */
      font-weight: 600;
      border-left: 4px solid var(--orix-logo-blue); /* ลดขนาดเส้นคั่น */
      padding-left: 6px; 
    }

    /* ---------------------------------------------------- */
    /* ** CSS Grid Layout (Mobile Default: Label & Input In-line) ** */
    /* ---------------------------------------------------- */
    .data-section {
        display: grid;
        /* **สำคัญ:** ปรับเป็น 2 คอลัมน์สำหรับมือถือ: Label 45%, Input 55% */
        grid-template-columns: 45% 55%; 
        gap: 5px 8px; /* ลดระยะห่าง */
        align-items: center;
        padding: 5px 0; /* ลด padding */
        border-bottom: 1px solid var(--orix-light-grey);
    }
    
    .data-section:last-child {
        border-bottom: none;
    }

    .data-label {
      font-weight: 500; /* ลดความหนาของ Label */
      color: var(--orix-dark-grey);
      margin-bottom: 0; /* ไม่มี margin ด้านล่าง เพราะอยู่บรรทัดเดียวกัน */
      font-size: 0.95em; /* ลดขนาดฟอนต์ Label */
    }

    .data-value {
      display: flex; 
    }

    .data-value input:not([readonly]),
    .data-value select {
      width: 100%;
      padding: 6px 8px; /* ลด padding ใน Input */
      border: 1px solid var(--orix-border-color);
      border-radius: 4px; /* ลดความโค้งมน */
      background: var(--input-bg-editable);
      color: var(--orix-dark-grey);
      box-sizing: border-box;
      text-align: right;
      font-size: 0.95em; /* ลดขนาดฟอนต์ Input */
      box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05); /* ลดขนาดเงาจม */
    }
    
    .data-value input#carInfo {
        text-align: left;
    }

    .data-value input[readonly] {
      width: 100%;
      padding: 6px 8px;
      border: 1px solid var(--orix-border-color);
      border-radius: 4px;
      background-color: var(--input-bg-readonly);
      font-weight: 600; 
      color: var(--highlight-text-color); 
      text-align: right;
      box-sizing: border-box;
      font-size: 0.95em;
    }
    
    #downPercentDisplay {
      font-weight: bold;
      color: var(--highlight-text-color);
      font-size: 0.95em;
      padding-left: 8px; /* ลด padding */
    }

    /* ---------------------------------------------------- */
    /* ** Button Group Styles ** */
    /* ---------------------------------------------------- */
    .button-group {
        display: grid;
        grid-template-columns: repeat(2, 1fr); /* ปุ่ม 2 คอลัมน์บนมือถือ */
        gap: 8px; /* ลดระยะห่าง */
        margin-top: 15px; 
    }

    .button-group button {
      padding: 10px 12px; /* ลดขนาดปุ่ม */
      font-size: 0.9em; 
      border-radius: 4px; 
      font-weight: 600;
    }

    /* ... (Button specific colors remain the same) ... */
    
    /* ---------------------------------------------------- */
    /* ** Desktop/Tablet Adjustments (Min-Width) ** */
    /* ---------------------------------------------------- */
    @media screen and (min-width: 601px) {
      body {
          padding: 10px; 
          font-size: 1.05em; /* เพิ่มขนาดฟอนต์กลับไปสำหรับจอใหญ่ */
      }
      
      .container {
        max-width: 900px; 
        padding: 20px;
        border-radius: 12px;
        margin: 20px auto;
        box-shadow: 0 10px 30px rgba(0, 51, 102, 0.1), 0 0 0 1px rgba(0, 0, 0, 0.05);
      }
      
      h1 {
        font-size: 2.2em;
        margin-bottom: 25px;
      }

      h2 {
        font-size: 1.6em;
        margin-top: 25px; 
        margin-bottom: 10px;
        border-left: 5px solid var(--orix-logo-blue); 
        padding-left: 10px;
      }
      
      .data-section {
        /* บนจอใหญ่ (601px ขึ้นไป) ใช้ 2 คอลัมน์แบบเดิมที่ใหญ่กว่า */
        grid-template-columns: 40% 60%; 
        gap: 8px 15px;
        padding: 10px 0;
      }
      
      .data-label {
          margin-bottom: 0; 
          font-weight: 600;
          font-size: 1.0em;
      }
      
      .data-value input:not([readonly]),
      .data-value select,
      .data-value input[readonly] {
          padding: 10px 12px;
          border-radius: 8px;
          font-size: 1.0em;
      }
      
      #downPercentDisplay {
          font-size: 1.05em;
          padding-left: 10px;
      }

      .button-group {
        /* บนจอใหญ่ให้ปุ่มเรียงเป็นแถวหลายคอลัมน์ */
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
        gap: 15px;
        margin-top: 30px;
      }
      
      .button-group button {
        padding: 15px 20px;
        font-size: 1.1em;
        border-radius: 8px;
      }
    }
    /* Button specific colors (ซ้ำไว้เพื่อให้โค้ดสมบูรณ์ในตัวเอง) */
    .button-group button:nth-of-type(1) {background: linear-gradient(145deg, #004080, var(--orix-logo-blue));box-shadow: 0 3px 10px rgba(0, 51, 102, 0.3);}
    .button-group button:nth-of-type(1):hover {background: linear-gradient(145deg, var(--orix-logo-blue), #00264d);transform: translateY(-2px);box-shadow: 0 6px 15px rgba(0, 51, 102, 0.4);}
    .button-group button:nth-of-type(2) {background: linear-gradient(145deg, #FF3B49, var(--orix-logo-red));box-shadow: 0 3px 10px rgba(227, 6, 19, 0.3);}
    .button-group button:nth-of-type(2):hover {background: linear-gradient(145deg, var(--orix-logo-red), #B0050D);transform: translateY(-2px);box-shadow: 0 6px 15px rgba(227, 6, 19, 0.4);}
    .button-group button:nth-of-type(3), .button-group button:nth-of-type(4) {background: linear-gradient(145deg, #4A73A2, #375F8A);box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);}
    .button-group button:nth-of-type(3):hover, .button-group button:nth-of-type(4):hover {background: linear-gradient(145deg, #375F8A, #2C4B6E);transform: translateY(-1px);box-shadow: 0 5px 10px rgba(0, 0, 0, 0.25);}
    .button-group button:active {transform: translateY(0);box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);}
  </style>
</head>
<body>

<div class="container">
  <h1>ORIX Financial Lease Calculator</h1>

  <h2>ข้อมูลเบื้องต้น</h2>
  
  <div class="data-section"><div class="data-label">ข้อมูลรถ</div><div class="data-value"><input id="carInfo" type="text" value=""></div></div>
  <div class="data-section"><div class="data-label">ราคารถ</div><div class="data-value"><input id="carPrice" type="text" value="0.00"></div></div>
  <div class="data-section"><div class="data-label">ส่วนลด</div><div class="data-value"><input id="discount" type="text" value="0.00"></div></div>
  <div class="data-section"><div class="data-label">Option</div><div class="data-value"><input id="option" type="text" value="0.00"></div></div>
  <div class="data-section"><div class="data-label">ราคาสุทธิ</div><div class="data-value"><input id="totalAmount" readonly></div></div>

  <h2>เงินดาวน์</h2>
  
  <div class="data-section">
      <div class="data-label">รูปแบบ</div>
      <div class="data-value">
        <select id="downType" onchange="calculate()">
          <option value="percent">เป็น %</option>
          <option value="amount">เป็นจำนวนเงิน</option>
        </select>
      </div>
  </div>
  <div class="data-section"><div class="data-label">กรอก % หรือ จำนวน</div><div class="data-value"><input id="downInput" type="text" value="0.00"></div></div>
  <div class="data-section"><div class="data-label">เงินดาวน์</div><div class="data-value"><input id="downAmount" readonly></div></div>
  <div class="data-section"><div class="data-label">เงินดาวน์คิดเป็น</div><div class="data-value"><span id="downPercentDisplay">-</span></div></div>

  <h2>ดอกเบี้ยและระยะเวลา</h2>
  
  <div class="data-section"><div class="data-label">อัตราดอกเบี้ย (%)</div><div class="data-value"><input id="interestRate" type="text" value="0.00"></div></div>
  <div class="data-section"><div class="data-label">จำนวนปี</div><div class="data-value"><input id="termYears" type="number" step="1" value="0"></div></div>

  <h2>ค่าคอมมิชชั่น</h2>
  
  <div class="data-section">
    <div class="data-label">คิดค่าคอมจาก</div>
    <div class="data-value">
      <select id="comBase" onchange="calculate()">
        <option value="interest">ดอกเบี้ยรวม</option>
        <option value="finance">ยอดจัด</option>
      </select>
    </div>
  </div>
  <div class="data-section"><div class="data-label">Commission (%)</div><div class="data-value"><input id="comPercent" type="text" value="0.00"></div></div>
  <div class="data-section"><div class="data-label">ค่าคอม (ที่คำนวณ)</div><div class="data-value"><input id="calculatedCommission" readonly></div></div>
  <div class="data-section"><div class="data-label">Extra Commission</div><div class="data-value"><input id="extra" type="text" value="0.00"></div></div>
  <div class="data-section"><div class="data-label">QS Extra Cost</div><div class="data-value"><input id="qsExtra" readonly></div></div>

  <h2>ผลลัพธ์</h2>
  
  <div class="data-section"><div class="data-label">ยอดจัด</div><div class="data-value"><input id="financeAmt" readonly></div></div>
  <div class="data-section"><div class="data-label">ดอกเบี้ยต่อปี</div><div class="data-value"><input id="intPA" readonly></div></div>
  <div class="data-section"><div class="data-label">ดอกเบี้ยรวม</div><div class="data-value"><input id="intTotal" readonly></div></div>
  <div class="data-section"><div class="data-label">ยอดจัดรวม</div><div class="data-value"><input id="financeTotalWithInterest" readonly></div></div>
  <div class="data-section"><div class="data-label">ค่างวด (In VAT)</div><div class="data-value"><input id="leaseInVat" readonly></div></div>
  <div class="data-section"><div class="data-label">ค่างวด (Ex VAT)</div><div class="data-value"><input id="leaseExVat" readonly></div></div>
  <div class="data-section"><div class="data-label">TR (Effective %)</div><div class="data-value"><input id="trRate" readonly></div></div>

  <h2>QS Information</h2>
  
  <div class="data-section"><div class="data-label">ข้อมูลรถ</div><div class="data-value"><input id="qsCarInfo" readonly></div></div>
  <div class="data-section"><div class="data-label">ราคารถ</div><div class="data-value"><input id="qsCarPrice" readonly></div></div>
  <div class="data-section"><div class="data-label">ส่วนลด</div><div class="data-value"><input id="qsDiscount" readonly></div></div>
  <div class="data-section"><div class="data-label">Option</div><div class="data-value"><input id="qsOption" readonly></div></div>
  <div class="data-section"><div class="data-label">เงินดาวน์</div><div class="data-value"><input id="qsDownAmount" readonly></div></div>
  <div class="data-section"><div class="data-label">เงินดาวน์คิดเป็น %</div><div class="data-value"><input id="qsDownPercent" readonly></div></div>
  <div class="data-section"><div class="data-label">TR (Effective %)</div><div class="data-value"><input id="qsTrRate" readonly></div></div>
  <div class="data-section"><div class="data-label">จำนวนปี</div><div class="data-value"><input id="qsTermYears" readonly></div></div>
  <div class="data-section"><div class="data-label">Deposit</div><div class="data-value"><input id="qsDeposit" readonly></div></div>
  <div class="data-section"><div class="data-label">RV</div><div class="data-value"><input id="qsRV" readonly></div></div>
  <div class="data-section"><div class="data-label">TR Dep</div><div class="data-value"><input id="qsTrDep" readonly></div></div>

  <div class="button-group">
    <button onclick="calculate()">คำนวณ</button>
    <button onclick="calculateDownForTargetLease(36000)">ค่างวด 36,000</button>
    <button onclick="generateQuotation()">ใบเสนอราคา</button>
    <button onclick="sendToQsData()">ส่งข้อมูล QS</button>
  </div>
</div>

<script>
// Helper functions for number formatting
function format(n, decimals = 2) {
  if (isNaN(n) || n === null) return "0.00";
  // Use Intl.NumberFormat for robust formatting with commas
  return new Intl.NumberFormat('en-US', {
    minimumFractionDigits: decimals,
    maximumFractionDigits: decimals
  }).format(parseFloat(n));
}

function formatNoDecimal(n) {
  return format(n, 0);
}

function format4(n) {
  if (isNaN(n) || n === null) return "0.0000";
  return new Intl.NumberFormat('en-US', {
    minimumFractionDigits: 4,
    maximumFractionDigits: 4
  }).format(parseFloat(n));
}

function uncomma(s) {
  // Handles both comma-formatted and non-formatted numbers, returns 0 if invalid
  const cleaned = String(s).replace(/,/g, '');
  const num = parseFloat(cleaned);
  return isNaN(num) ? 0 : num;
}

// Function to calculate IRR (Effective Interest Rate per period)
function calculateIRR(nper, pmt, pv, fv = 0, type = 0) {
  if (pmt === 0 && pv === 0) return NaN;
  if (nper <= 0) return NaN;

  let guess = 0.05 / 12; // Initial guess for monthly rate
  let rate = guess;
  const maxIter = 500;
  const tol = 1e-7;

  for (let i = 0; i < maxIter; i++) {
    let f = pv;
    let df = 0;

    for (let t = 1; t <= nper; t++) {
      const discountFactor = Math.pow(1 + rate, t - (type === 1 ? 1 : 0));
      f += pmt / discountFactor;
      df += -(t - (type === 1 ? 1 : 0)) * pmt / Math.pow(1 + rate, t + 1 - (type === 1 ? 1 : 0));
    }
    f += fv / Math.pow(1 + rate, nper);
    df += -nper * fv / Math.pow(1 + rate, nper + 1);

    if (Math.abs(f) < tol) return rate;

    const newRate = rate - f / df;
    if (Math.abs(newRate - rate) < tol) return newRate;
    if (isNaN(newRate) || !isFinite(newRate)) return NaN;

    rate = newRate;
  }
  return NaN;
}

function showDownPercent() {
  const total = uncomma(document.getElementById("totalAmount").value);
  const down = uncomma(document.getElementById("downAmount").value);
  const result = total > 0 ? (down / total * 100) : 0;
  document.getElementById("downPercentDisplay").innerText = `(${format4(result)}%)`;
  document.getElementById("qsDownPercent").value = format4(result) + '%';
}

function calculate() {
  const getVal = id => uncomma(document.getElementById(id).value);
  const getIntVal = id => parseInt(uncomma(document.getElementById(id).value)) || 0; 
  const getComPercent = id => uncomma(document.getElementById(id).value);

  const carInfo = document.getElementById('carInfo').value;
  const car = getVal('carPrice');
  const discount = getVal('discount');
  const option = getVal('option');
  const total = car - discount + option;
  document.getElementById('totalAmount').value = format(total);

  const downType = document.getElementById('downType').value;
  const downInput = getVal('downInput');
  let down = 0;
  if (downType === 'percent') {
    down = total * (downInput / 100);
  } else {
    down = downInput;
  }
  document.getElementById('downAmount').value = format(down);

  const finance = total - down;
  const rate = getVal('interestRate');
  const years = getIntVal('termYears');
  const months = years * 12;

  if (months === 0) {
      document.getElementById('financeAmt').value = format(finance);
      document.getElementById('intPA').value = format(0);
      document.getElementById('intTotal').value = format(0);
      document.getElementById('financeTotalWithInterest').value = format(finance);
      document.getElementById('calculatedCommission').value = format(0);
      document.getElementById('qsExtra').value = format(0);
      document.getElementById('leaseInVat').value = format(0);
      document.getElementById('leaseExVat').value = format(0);
      document.getElementById('trRate').value = 'ไม่สามารถคำนวณ';
      document.getElementById('qsTrDep').value = 'ไม่สามารถคำนวณ';
      showDownPercent();
      updateQsInfo(carInfo, car, discount, option, down, years, 0, 0, 0); 
      return;
  }

  const intPA = finance * (rate / 100);
  const intTotal = intPA * years;
  const financeTotalWithInterest = finance + intTotal;
  document.getElementById('financeTotalWithInterest').value = format(financeTotalWithInterest);

  const comBase = document.getElementById('comBase').value;
  const comPercent = getComPercent('comPercent');
  const extra = getVal('extra');
  const comBaseVal = comBase === "finance" ? finance : intTotal;
  const commission = Math.ceil(comBaseVal * (comPercent / 100));
  const qsExtraCost = commission + extra;

  const leaseInVat = Math.ceil(financeTotalWithInterest / months);
  const leaseExVat = leaseInVat / 1.07;

  // TR Calculation (Effective %)
  const pvForIRR = -(finance + (commission * 1.07) + (extra * 1.07));
  const tr = calculateIRR(months, leaseInVat, pvForIRR, 0, 0) * 12 * 100;

  // TR Dep Calculation (ปรับปรุงตามสูตรใหม่ล่าสุด)
  const pvForTRDep = -(total + (commission * 1.07) + (extra * 1.07));
  const trDep = calculateIRR(months, leaseInVat, pvForTRDep, down, 0) * 12 * 100;


  document.getElementById('financeAmt').value = format(finance);
  document.getElementById('intPA').value = format(intPA);
  document.getElementById('intTotal').value = format(intTotal);
  document.getElementById('calculatedCommission').value = format(commission);
  document.getElementById('qsExtra').value = format(qsExtraCost); 
  document.getElementById('leaseInVat').value = format(leaseInVat);
  document.getElementById('leaseExVat').value = format(leaseExVat);
  document.getElementById('trRate').value = isNaN(tr) ? 'ไม่สามารถคำนวณ' : format4(tr);
  document.getElementById('qsTrDep').value = isNaN(trDep) ? 'ไม่สามารถคำนวณ' : format4(trDep);

  updateQsInfo(carInfo, car, discount, option, down, years, tr, trDep, qsExtraCost);
  showDownPercent();
}

function updateQsInfo(carInfo, car, discount, option, down, years, tr, trDep, qsExtraCost) {
    document.getElementById('qsCarInfo').value = carInfo;
    document.getElementById('qsCarPrice').value = format(car);
    document.getElementById('qsDiscount').value = format(discount);
    document.getElementById('qsOption').value = format(option);
    document.getElementById('qsDownAmount').value = format(down);
    document.getElementById('qsTrRate').value = isNaN(tr) ? 'ไม่สามารถคำนวณ' : format4(tr);
    document.getElementById('qsTermYears').value = years;
    document.getElementById('qsDeposit').value = format(down / 1.07, 4); 
    const totalAmount = uncomma(document.getElementById('totalAmount').value);
    document.getElementById('qsRV').value = format4(totalAmount > 0 ? (down / totalAmount * 100) : 0) + '%';
    document.getElementById('qsTrDep').value = isNaN(trDep) ? 'ไม่สามารถคำนวณ' : format4(trDep);
    document.getElementById('qsExtra').value = format(qsExtraCost);
}

function calculateDownForTargetLease(targetLease) {
  const getVal = id => uncomma(document.getElementById(id).value);
  const getIntVal = id => parseInt(uncomma(document.getElementById(id).value)) || 0;

  const car = getVal('carPrice');
  const discount = getVal('discount');
  const option = getVal('option');
  const total = car - discount + option;
  document.getElementById('totalAmount').value = format(total);

  const rate = getVal('interestRate');
  const years = getIntVal('termYears');
  const months = years * 12;

  if (months === 0 || rate === 0) {
      alert("กรุณาระบุจำนวนปีและอัตราดอกเบี้ยก่อนคำนวณเงินดาวน์สำหรับค่างวดเป้าหมาย.");
      return;
  }
  if (total <= 0) {
      alert("กรุณาระบุราคารถให้ถูกต้อง (มากกว่า 0) เพื่อคำนวณเงินดาวน์.");
      return;
  }

  // 1. ลองคำนวณที่เงินดาวน์เป็น 0 (ดาวน์ต่ำสุดที่เป็นไปได้)
  const financeZeroDown = total;
  const intTotalZeroDown = financeZeroDown * (rate / 100) * years;
  const leaseInVatZeroDown = months > 0 ? Math.ceil((financeZeroDown + intTotalZeroDown) / months) : 0;

  if (leaseInVatZeroDown < targetLease) {
    // 2. ถ้าค่างวดที่เงินดาวน์ 0 ยังไม่ถึงเป้าหมาย (36,000)
    document.getElementById('downType').value = 'amount';
    document.getElementById('downInput').value = formatNoDecimal(0); // กำหนดเงินดาวน์เป็น 0
    calculate(); // คำนวณอีกครั้งเพื่อแสดงผลลัพธ์ค่างวดที่ไม่ถึง 36,000
    alert(`ไม่สามารถคำนวณให้ค่างวดถึง ${formatNoDecimal(targetLease)} บาทได้ แม้จะดาวน์ 0 บาท ค่างวดที่ได้คือ ${formatNoDecimal(leaseInVatZeroDown)} บาท จึงกำหนดให้เงินดาวน์เป็น 0`);
  } else {
    // 3. ถ้าค่างวดที่เงินดาวน์ 0 ถึงเป้าหมาย (หรือมากกว่า) ให้ใช้ Binary Search หาเงินดาวน์ที่เหมาะสม

    let low = 0;
    let high = total;
    let bestDown = 0;
    let minDiff = Infinity;

    const maxIter = 500;

    for (let i = 0; i < maxIter; i++) {
        const currentDown = Math.ceil((low + high) / 2); 

        if (currentDown < 0) currentDown = 0;
        if (currentDown > total) currentDown = total;

        const finance = total - currentDown;
        const intTotal = finance * (rate / 100) * years;
        const currentLease = months > 0 ? Math.ceil((finance + intTotal) / months) : 0;

        const diff = Math.abs(currentLease - targetLease);

        // ตรวจสอบความแม่นยำหรือการลู่เข้า
        if (diff < minDiff) {
            minDiff = diff;
            bestDown = currentDown;
        }

        if (Math.abs(high - low) < 1 || diff < 0.1) {
            break;
        }

        if (currentLease > targetLease) {
          low = currentDown; // ต้องเพิ่มเงินดาวน์
        } else {
          high = currentDown; // สามารถลดเงินดาวน์ได้
        }
    }

    document.getElementById('downType').value = 'amount';
    document.getElementById('downInput').value = formatNoDecimal(bestDown);
    calculate();
  }
}

function generateQuotation() {
    calculate(); 

    const data = {
        carInfo: document.getElementById('carInfo').value,
        carPrice: uncomma(document.getElementById('carPrice').value),
        discount: uncomma(document.getElementById('discount').value),
        option: uncomma(document.getElementById('option').value),
        totalAmount: uncomma(document.getElementById('totalAmount').value),
        downAmount: uncomma(document.getElementById('downAmount').value),
        downPercent: parseFloat(document.getElementById('downPercentDisplay').innerText.replace(/[()%]/g, '')),
        
        interestRate: uncomma(document.getElementById('interestRate').value),
        termYears: parseInt(document.getElementById('termYears').value) || 0,
        
        comBase: document.getElementById('comBase').value,
        comPercent: uncomma(document.getElementById('comPercent').value),
        calculatedCommission: uncomma(document.getElementById('calculatedCommission').value),
        extra: uncomma(document.getElementById('extra').value),
        qsExtra: uncomma(document.getElementById('qsExtra').value), 

        financeAmt: uncomma(document.getElementById('financeAmt').value),
        intPA: uncomma(document.getElementById('intPA').value),
        intTotal: uncomma(document.getElementById('intTotal').value),
        financeTotalWithInterest: uncomma(document.getElementById('financeTotalWithInterest').value),
        leaseInVat: uncomma(document.getElementById('leaseInVat').value),
        leaseExVat: uncomma(document.getElementById('leaseExVat').value),
        trRate: parseFloat(document.getElementById('trRate').value.replace('ไม่สามารถคำนวณ', 'NaN')),
        
        // QS Information fields
        qsCarInfo: document.getElementById('qsCarInfo').value,
        qsCarPrice: uncomma(document.getElementById('qsCarPrice').value),
        qsDiscount: uncomma(document.getElementById('qsDiscount').value),
        qsOption: uncomma(document.getElementById('qsOption').value),
        qsDownAmount: uncomma(document.getElementById('qsDownAmount').value),
        qsDownPercent: parseFloat(document.getElementById('qsDownPercent').value.replace(/[()%]/g, '')),
        qsTrRate: parseFloat(document.getElementById('qsTrRate').value.replace('ไม่สามารถคำนวณ', 'NaN')),
        qsTermYears: parseInt(document.getElementById('qsTermYears').value) || 0,
        qsDeposit: uncomma(document.getElementById('qsDeposit').value),
        qsRV: parseFloat(document.getElementById('qsRV').value.replace('%', '')),
        qsTrDep: parseFloat(document.getElementById('qsTrDep').value.replace('ไม่สามารถคำนวณ', 'NaN')),
    };

    localStorage.setItem('quotationData', JSON.stringify(data));
    window.open('quotation.html', '_blank');
}


function sendToQsData() {
    calculate();

    const qsExtraCost = uncomma(document.getElementById('qsExtra').value);
    const downAmount = uncomma(document.getElementById('downAmount').value);
    const totalAmount = uncomma(document.getElementById('totalAmount').value);
    const trRateEffective = parseFloat(document.getElementById('trRate').value.replace('ไม่สามารถคำนวณ', 'NaN'));
    const termYears = parseInt(document.getElementById('termYears').value) || 0;
    const deposit = uncomma(document.getElementById('qsDeposit').value);
    const rv = parseFloat(document.getElementById('qsRV').value.replace('%', ''));
    const trDep = parseFloat(document.getElementById('qsTrDep').value.replace('ไม่สามารถคำนวณ', 'NaN'));
    const downPercent = parseFloat(document.getElementById('downPercentDisplay').innerText.replace(/[()%]/g, ''));
    const leaseExVat = uncomma(document.getElementById('leaseExVat').value);


    const dataForQs = {
        // Basic Info
        carInfo: document.getElementById('carInfo').value,
        carPrice: uncomma(document.getElementById('carPrice').value),
        discount: uncomma(document.getElementById('discount').value),
        option: uncomma(document.getElementById('option').value),
        totalAmount: totalAmount,

        // QS specific values
        qsExtraCost: qsExtraCost,
        downAmount: downAmount,
        qsDownPercent: downPercent,
        trRateEffective: trRateEffective,
        termYears: termYears,
        deposit: deposit,
        rv: rv,
        trDep: trDep,
        leaseExVat: leaseExVat
    };

    localStorage.setItem('qsData', JSON.stringify(dataForQs));
    window.open('qs_data.html', '_blank');
}


// Event Listeners for input fields
function addInputListeners(id) {
  const el = document.getElementById(id);

  if (id === 'carInfo') {
      el.addEventListener('blur', calculate);
  } else { // All other number/percent inputs
      el.addEventListener('focus', () => {
          let currentVal = uncomma(el.value);
          if (Math.abs(currentVal) < 0.001) {
              el.value = '';
          } else {
              el.value = String(currentVal);
          }
      });
      el.addEventListener('blur', () => {
          let val = uncomma(el.value);
          if (id === 'termYears') {
              el.value = formatNoDecimal(val);
          } else if (id === 'interestRate' || id === 'comPercent') {
              el.value = format(val, 2);
          }
          else {
              el.value = format(val);
          }
          calculate();
      });
      el.addEventListener('input', () => {
          let sanitizedValue = el.value.replace(/[^0-9.]/g, '');
          const parts = sanitizedValue.split('.');
          if (parts.length > 2) {
              sanitizedValue = parts[0] + '.' + parts.slice(1).join('');
          }
          el.value = sanitizedValue;
      });
  }
}

window.onload = () => {
  ['carPrice', 'discount', 'option', 'downInput', 'interestRate', 'extra', 'termYears', 'comPercent', 'carInfo'].forEach(addInputListeners);
  document.getElementById('downType').addEventListener('change', calculate);
  document.getElementById('comBase').addEventListener('change', calculate);
  calculate(); // Initial calculation on load
};
</script>

</body>
</html>
