<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>Lease Calculator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    :root {
      /* ORIX Logo Colors based on provided image */
      --orix-logo-blue: #003366; /* Dark blue from ORIX logo text */
      --orix-logo-red: #E30613;  /* Red from ORIX logo symbol */

      /* General UI Colors, adapted to ORIX theme */
      --orix-white: #FFFFFF;
      --orix-light-grey: #F8FBFD; /* Very light background for contrast */
      --orix-dark-grey: #333333;
      --orix-border-color: #DDEBF5; /* Soft, slightly bluish border */
      --input-bg-editable: #FFFDE1; /* Adjusted: A clear, light yellow for editable inputs */
      --input-bg-readonly: #ECECEC; /* Adjusted: A clear, light grey for readonly inputs */
      --highlight-text-color: var(--orix-logo-blue); /* Emphasize calculated values */
    }

    body {
      font-family: 'Kanit', sans-serif;
      margin: 0;
      padding: 10px;
      background: var(--orix-light-grey);
      color: var(--orix-dark-grey);
      line-height: 1.4; /* ‡∏•‡∏î line-height */
      font-size: 1.05em;
    }

    .container {
      max-width: 800px;
      margin: 10px auto;
      background: var(--orix-white);
      padding: 18px;
      border-radius: 10px;
      box-shadow: 0 3px 12px rgba(0, 0, 0, 0.08);
      border: 1px solid var(--orix-border-color);
    }

    h1 {
      text-align: center;
      color: var(--orix-logo-blue);
      margin-bottom: 18px; /* ‡∏•‡∏î margin-bottom */
      font-size: 2.2em;
      font-weight: 600;
    }

    h2 {
      margin-top: 22px; /* ‡∏•‡∏î margin-top */
      margin-bottom: 10px; /* ‡∏•‡∏î margin-bottom */
      color: var(--orix-logo-blue);
      font-size: 1.6em;
      border-bottom: 1px solid var(--orix-border-color);
      padding-bottom: 4px; /* ‡∏•‡∏î padding-bottom */
    }

    table {
      width: 100%;
      margin-bottom: 15px; /* ‡∏•‡∏î margin-bottom */
      border-collapse: separate;
      border-spacing: 0 6px; /* ‡∏•‡∏î space ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á rows */
    }

    td {
      padding: 7px; /* ‡∏•‡∏î padding */
      vertical-align: middle;
      border-bottom: 1px solid var(--orix-border-color);
    }

    td.label {
      width: 45%;
      font-weight: 600;
      color: var(--orix-dark-grey);
    }

    td.value {
      width: 55%;
    }

    td.value input:not([readonly]),
    td.value select {
      width: 100%;
      padding: 7px 8px; /* ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î padding */
      border: 1px solid var(--orix-border-color);
      border-radius: 6px;
      background: var(--input-bg-editable);
      color: var(--orix-dark-grey);
      box-sizing: border-box;
      transition: all 0.3s ease;
      text-align: right;
      font-size: 1em;
    }

    td.value input#carInfo {
      text-align: left;
    }

    td.value input#termYears,
    td.value input#comPercent {
      -moz-appearance: textfield;
    }
    td.value input#termYears::-webkit-outer-spin-button,
    td.value input#termYears::-webkit-inner-spin-button,
    td.value input#comPercent::-webkit-outer-spin-button,
    td.value input#comPercent::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    td.value input::placeholder {
      color: #aaa;
    }

    td.value input:not([readonly]):focus,
    td.value select:focus {
      border-color: var(--orix-logo-blue);
      box-shadow: 0 0 0 0.2rem rgba(0, 51, 102, 0.2);
      outline: none;
    }

    td.value input[readonly] {
      width: 100%;
      padding: 7px 8px; /* ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î padding */
      border: 1px solid var(--orix-border-color);
      border-radius: 6px;
      background-color: var(--input-bg-readonly);
      font-weight: bold;
      color: var(--highlight-text-color);
      text-align: right;
      box-sizing: border-box;
      font-size: 1em;
    }

    .button-group {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 15px;
        justify-content: center;
    }

    .button-group button {
      flex: 1;
      min-width: 170px; /* ‡∏•‡∏î min-width */
      max-width: 270px; /* ‡∏•‡∏î max-width */
      padding: 9px 14px; /* ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î padding */
      font-size: 1em; /* ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î font-size */
      color: var(--orix-white);
      border: none;
      border-radius: 7px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
      box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
    }

    /* Adjusted Button Colors to ORIX Website Theme (more serious/professional) */
    .button-group button:nth-of-type(1) { /* ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì */
      background-image: linear-gradient(145deg, #004A8D, #003366);
    }
    .button-group button:nth-of-type(1):hover {
      background-image: linear-gradient(145deg, #003366, #00254D);
      transform: translateY(-2px);
      box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
    }

    .button-group button:nth-of-type(2) { /* ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î 36,000 ‡∏ö‡∏≤‡∏ó */
      background-image: linear-gradient(145deg, #5D728A, #4A5C6F);
    }
    .button-group button:nth-of-type(2):hover {
      background-image: linear-gradient(145deg, #4A5C6F, #3C4B5E);
      transform: translateY(-2px);
      box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
    }

    .button-group button:nth-of-type(3) { /* ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ */
      background-image: linear-gradient(145deg, #1A7560, #145E4D);
    }
    .button-group button:nth-of-type(3):hover {
      background-image: linear-gradient(145deg, #145E4D, #0F4A3C);
      transform: translateY(-2px);
      box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
    }

    .button-group button:nth-of-type(4) { /* ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏ó‡∏≥ QS */
        background-image: linear-gradient(145deg, #7A5DA8, #604A81);
    }
    .button-group button:nth-of-type(4):hover {
        background-image: linear-gradient(145deg, #604A81, #4E3A6B);
        transform: translateY(-2px);
        box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
    }

    .button-group button:nth-of-type(5) { /* Export PDF */
        background-image: linear-gradient(145deg, #E30613, #B8050F);
    }
    .button-group button:nth-of-type(5):hover {
        background-image: linear-gradient(145deg, #B8050F, #8F040C);
        transform: translateY(-2px);
        box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
    }

    .button-group button:active {
      transform: translateY(0);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    #downPercentDisplay {
      font-weight: bold;
      color: var(--highlight-text-color);
      font-size: 1.05em;
    }

    /* Responsive adjustments for smaller screens (e.g., mobile phones) */
    @media screen and (max-width: 768px) {
      body {
        padding: 5px; /* ‡∏•‡∏î padding ‡∏Ç‡∏≠‡∏á body ‡∏•‡∏á‡∏≠‡∏µ‡∏Å */
        font-size: 0.88em; /* ‡∏•‡∏î font-size ‡πÇ‡∏î‡∏¢‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á body */
      }
      .container {
        margin: 5px; /* ‡∏•‡∏î margin ‡∏Ç‡∏≠‡∏á container */
        padding: 10px; /* ‡∏•‡∏î padding ‡∏Ç‡∏≠‡∏á container */
      }

      h1 {
        font-size: 1.5em; /* ‡∏•‡∏î h1 */
        margin-bottom: 10px; /* ‡∏•‡∏î margin-bottom */
        margin-top: 10px; /* ‡∏•‡∏î margin-top */
      }

      h2 {
        font-size: 1.2em; /* ‡∏•‡∏î h2 */
        margin-top: 15px; /* ‡∏•‡∏î margin-top */
        margin-bottom: 6px; /* ‡∏•‡∏î margin-bottom */
        padding-bottom: 3px; /* ‡∏•‡∏î padding-bottom */
      }

      table {
        border-spacing: 0 4px; /* ‡∏•‡∏î space ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á rows ‡πÉ‡∏´‡πâ‡∏ä‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏≠‡∏µ‡∏Å */
        margin-bottom: 8px; /* ‡∏•‡∏î margin-bottom */
      }

      td {
        padding: 4px 0; /* ‡∏•‡∏î padding ‡∏Ç‡∏≠‡∏á td ‡πÉ‡∏´‡πâ‡∏ä‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡∏Å */
      }

      td.label {
        font-size: 0.85em; /* ‡∏•‡∏î font-size ‡∏Ç‡∏≠‡∏á label */
      }

      td.value input:not([readonly]),
      td.value select,
      td.value input[readonly] {
        font-size: 0.88em; /* ‡∏•‡∏î font-size ‡∏Ç‡∏≠‡∏á input */
        padding: 5px 6px; /* ‡∏•‡∏î padding ‡∏Ç‡∏≠‡∏á input */
      }

      table tr {
        margin-bottom: 8px; /* ‡∏•‡∏î margin-bottom ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ñ‡∏ß */
        padding: 4px; /* ‡∏•‡∏î padding ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ñ‡∏ß */
      }
      
      .button-group {
        flex-direction: column;
        gap: 6px; /* ‡∏•‡∏î gap ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏° */
        margin-top: 10px; /* ‡∏•‡∏î margin-top ‡∏Ç‡∏≠‡∏á button group */
      }
      .button-group button {
        width: 100%;
        padding: 8px; /* ‡∏•‡∏î padding ‡∏Ç‡∏≠‡∏á‡∏õ‡∏∏‡πà‡∏° */
        font-size: 0.9em; /* ‡∏•‡∏î font-size ‡∏Ç‡∏≠‡∏á‡∏õ‡∏∏‡πà‡∏° */
      }
    }
  </style>
</head>
<body>

<div class="container">
  <h1>Lease Calculator</h1>

  <h2>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô</h2>
  <table>
    <tr><td class="label">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏ñ</td><td class="value"><input id="carInfo" type="text" value=""></td></tr>
    <tr><td class="label">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ñ</td><td class="value"><input id="carPrice" type="text" value="0.00"></td></tr>
    <tr><td class="label">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</td><td class="value"><input id="discount" type="text" value="0.00"></td></tr>
    <tr><td class="label">Option</td><td class="value"><input id="option" type="text" value="0.00"></td></tr>
    <tr><td class="label">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</td><td class="value"><input id="totalAmount" readonly></td></tr>
  </table>

  <h2>‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå</h2>
  <table>
    <tr>
      <td class="label">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö</td>
      <td class="value">
        <select id="downType" onchange="calculate()">
          <option value="percent">‡πÄ‡∏õ‡πá‡∏ô %</option>
          <option value="amount">‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</option>
        </select>
      </td>
    </tr>
    <tr><td class="label">‡∏Å‡∏£‡∏≠‡∏Å % ‡∏´‡∏£‡∏∑‡∏≠ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</td><td class="value"><input id="downInput" type="text" value="0.00"></td></tr>
    <tr><td class="label">‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå</td><td class="value"><input id="downAmount" readonly></td></tr>
    <tr><td class="label">‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå‡∏Ñ‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô</td><td class="value"><span id="downPercentDisplay">-</span></td></tr>
  </table>

  <h2>‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤</h2>
  <table>
    <tr><td class="label">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢ (%)</td><td class="value"><input id="interestRate" type="text" value="0.00"></td></tr>
    <tr><td class="label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏µ</td><td class="value"><input id="termYears" type="number" step="1" value="0"></td></tr>
  </table>

  <h2>‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô</h2>
  <table>
    <tr><td class="label">‡∏Ñ‡∏¥‡∏î‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏à‡∏≤‡∏Å</td>
      <td class="value">
        <select id="comBase" onchange="calculate()">
          <option value="interest">‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏£‡∏ß‡∏°</option>
          <option value="finance">‡∏¢‡∏≠‡∏î‡∏à‡∏±‡∏î</option>
        </select>
      </td>
    </tr>
    <tr><td class="label">Commission (%)</td><td class="value"><input id="comPercent" type="number" step="1" value="0"></td></tr>
    <tr><td class="label">‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏° (‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì)</td><td class="value"><input id="calculatedCommission" readonly></td></tr>
    <tr><td class="label">Extra Commission</td><td class="value"><input id="extra" type="text" value="0.00"></td></tr>
    <tr><td class="label">QS Extra Cost</td><td class="value"><input id="qsExtra" readonly></td></tr>
  </table>

  <h2>‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</h2>
  <table>
    <tr><td class="label">‡∏¢‡∏≠‡∏î‡∏à‡∏±‡∏î</td><td class="value"><input id="financeAmt" readonly></td></tr>
    <tr><td class="label">‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏ï‡πà‡∏≠‡∏õ‡∏µ</td><td class="value"><input id="intPA" readonly></td></tr>
    <tr><td class="label">‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏£‡∏ß‡∏°</td><td class="value"><input id="intTotal" readonly></td></tr>
    <tr><td class="label">‡∏¢‡∏≠‡∏î‡∏à‡∏±‡∏î‡∏£‡∏ß‡∏°</td><td class="value"><input id="financeTotalWithInterest" readonly></td></tr>
    <tr><td class="label">‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î (In VAT)</td><td class="value"><input id="leaseInVat" readonly></td></tr>
    <tr><td class="label">‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î (Ex VAT)</td><td class="value"><input id="leaseExVat" readonly></td></tr>
    <tr><td class="label">TR (Effective %)</td><td class="value"><input id="trRate" readonly></td></tr>
  </table>

  <h2>QS Information</h2>
  <table>
    <tr><td class="label">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏ñ</td><td class="value"><input id="qsCarInfo" readonly></td></tr>
    <tr><td class="label">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ñ</td><td class="value"><input id="qsCarPrice" readonly></td></tr>
    <tr><td class="label">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</td><td class="value"><input id="qsDiscount" readonly></td></tr>
    <tr><td class="label">Option</td><td class="value"><input id="qsOption" readonly></td></tr>
    <tr><td class="label">‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå</td><td class="value"><input id="qsDownAmount" readonly></td></tr>
    <tr><td class="label">‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå‡∏Ñ‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô %</td><td class="value"><input id="qsDownPercent" readonly></td></tr>
    <tr><td class="label">TR (Effective %)</td><td class="value"><input id="qsTrRate" readonly></td></tr>
    <tr><td class="label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏µ</td><td class="value"><input id="qsTermYears" readonly></td></tr>
    <tr><td class="label">Deposit</td><td class="value"><input id="qsDeposit" readonly></td></tr>
    <tr><td class="label">RV</td><td class="value"><input id="qsRV" readonly></td></tr>
    <tr><td class="label">TR Dep</td><td class="value"><input id="qsTrDep" readonly></td></tr>
  </table>

  <div class="button-group">
    <button onclick="calculate()">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</button>
    <button onclick="calculateDownForTargetLease(36000)">üìä ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î 36,000 ‡∏ö‡∏≤‡∏ó</button>
    <button onclick="generateQuotation()">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤</button>
    <button onclick="sendToQsData()">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏ó‡∏≥ QS</button>
    <button onclick="exportToPdf()">üìÑ Export PDF</button>
  </div>
</div>

<script>
// Helper functions for number formatting
function format(n, decimals = 2) {
  if (isNaN(n) || n === null) return "0.00";
  return new Intl.NumberFormat('en-US', {
    minimumFractionDigits: decimals,
    maximumFractionDigits: decimals
  }).format(parseFloat(n));
}

function formatNoDecimal(n) {
  return format(n, 0);
}

function format4(n) {
  if (isNaN(n) || n === null) return "0.0000";
  return new Intl.NumberFormat('en-US', {
    minimumFractionDigits: 4,
    maximumFractionDigits: 4
  }).format(parseFloat(n));
}

function uncomma(s) {
  const cleaned = String(s).replace(/,/g, '');
  const num = parseFloat(cleaned);
  return isNaN(num) ? 0 : num;
}

// Function to calculate IRR (Effective Interest Rate per period)
function calculateIRR(nper, pmt, pv, fv = 0, type = 0) {
  if (pmt === 0 && pv === 0) return NaN;
  if (nper <= 0) return NaN;

  let guess = 0.05 / 12; // Initial guess for monthly rate
  let rate = guess;
  const maxIter = 500;
  const tol = 1e-7;

  for (let i = 0; i < maxIter; i++) {
    let f = pv;
    let df = 0;

    for (let t = 1; t <= nper; t++) {
      const discountFactor = Math.pow(1 + rate, t - (type === 1 ? 1 : 0));
      f += pmt / discountFactor;
      df += -(t - (type === 1 ? 1 : 0)) * pmt / Math.pow(1 + rate, t + 1 - (type === 1 ? 1 : 0));
    }
    f += fv / Math.pow(1 + rate, nper);
    df += -nper * fv / Math.pow(1 + rate, nper + 1);

    if (Math.abs(f) < tol) return rate;

    const newRate = rate - f / df;
    if (Math.abs(newRate - rate) < tol) return newRate;
    if (isNaN(newRate) || !isFinite(newRate)) return NaN;

    rate = newRate;
  }
  return NaN;
}

function showDownPercent() {
  const total = uncomma(document.getElementById("totalAmount").value);
  const down = uncomma(document.getElementById("downAmount").value);
  const result = total > 0 ? (down / total * 100) : 0;
  document.getElementById("downPercentDisplay").innerText = `(${format4(result)}%)`;
  document.getElementById("qsDownPercent").value = format4(result) + '%';
}

function calculate() {
  const getVal = id => uncomma(document.getElementById(id).value);
  const getIntVal = id => parseInt(uncomma(document.getElementById(id).value)) || 0;

  const carInfo = document.getElementById('carInfo').value;
  const car = getVal('carPrice');
  const discount = getVal('discount');
  const option = getVal('option');
  const total = car - discount + option;
  document.getElementById('totalAmount').value = format(total);

  const downType = document.getElementById('downType').value;
  const downInput = getVal('downInput');
  let down = 0;
  if (downType === 'percent') {
    down = total * (downInput / 100);
  } else {
    down = downInput;
  }
  document.getElementById('downAmount').value = format(down);

  const finance = total - down;
  const rate = getVal('interestRate');
  const years = getIntVal('termYears');
  const months = years * 12;

  if (months === 0 || total <= 0) {
      document.getElementById('financeAmt').value = format(finance);
      document.getElementById('intPA').value = format(0);
      document.getElementById('intTotal').value = format(0);
      document.getElementById('financeTotalWithInterest').value = format(finance);
      document.getElementById('calculatedCommission').value = format(0);
      document.getElementById('qsExtra').value = format(0);
      document.getElementById('leaseInVat').value = format(0);
      document.getElementById('leaseExVat').value = format(0);
      document.getElementById('trRate').value = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì';
      document.getElementById('qsTrDep').value = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì';
      showDownPercent();
      updateQsInfo(carInfo, car, discount, option, down, years, 0, 0, 0, 0, 0);
      return;
  }

  const intPA = finance * (rate / 100);
  const intTotal = intPA * years;
  const financeTotalWithInterest = finance + intTotal;
  document.getElementById('financeTotalWithInterest').value = format(financeTotalWithInterest);

  const comBase = document.getElementById('comBase').value;
  const comPercent = getIntVal('comPercent');
  const extra = getVal('extra');
  const comBaseVal = comBase === "finance" ? finance : intTotal;
  const commission = Math.ceil(comBaseVal * (comPercent / 100));
  const qsExtraCost = commission + extra;

  const leaseInVat = Math.ceil(financeTotalWithInterest / months);
  const leaseExVat = leaseInVat / 1.07;

  const pvForIRR = -(finance + (commission * 1.07) + (extra * 1.07));
  const tr = calculateIRR(months, leaseInVat, pvForIRR, 0, 0) * 12 * 100;

  const pvForTRDep = -(total + (commission * 1.07) + (extra * 1.07));
  const trDep = calculateIRR(months, leaseInVat, pvForIRR + (down * 1.07), 0, 0) * 12 * 100; // Adjusted TR Dep calculation for accuracy


  document.getElementById('financeAmt').value = format(finance);
  document.getElementById('intPA').value = format(intPA);
  document.getElementById('intTotal').value = format(intTotal);
  document.getElementById('calculatedCommission').value = format(commission);
  document.getElementById('qsExtra').value = format(qsExtraCost);
  document.getElementById('leaseInVat').value = format(leaseInVat);
  document.getElementById('leaseExVat').value = format(leaseExVat);
  document.getElementById('trRate').value = isNaN(tr) || !isFinite(tr) ? '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì' : format4(tr);
  document.getElementById('qsTrDep').value = isNaN(trDep) || !isFinite(trDep) ? '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì' : format4(trDep);

  updateQsInfo(carInfo, car, discount, option, down, years, tr, trDep, qsExtraCost, leaseExVat, leaseInVat);
  showDownPercent();
}

function updateQsInfo(carInfo, car, discount, option, down, years, tr, trDep, qsExtraCost, leaseExVat, leaseInVat) {
    document.getElementById('qsCarInfo').value = carInfo;
    document.getElementById('qsCarPrice').value = format(car);
    document.getElementById('qsDiscount').value = format(discount);
    document.getElementById('qsOption').value = format(option);
    document.getElementById('qsDownAmount').value = format(down);
    document.getElementById('qsTrRate').value = isNaN(tr) || !isFinite(tr) ? '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì' : format4(tr);
    document.getElementById('qsTermYears').value = years;
    document.getElementById('qsDeposit').value = format(down / 1.07, 4);
    const totalAmount = uncomma(document.getElementById('totalAmount').value);
    document.getElementById('qsRV').value = format4(totalAmount > 0 ? (down / totalAmount * 100) : 0) + '%';
    document.getElementById('qsTrDep').value = isNaN(trDep) || !isFinite(trDep) ? '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì' : format4(trDep);
}

function calculateDownForTargetLease(targetLease) {
  const getVal = id => uncomma(document.getElementById(id).value);
  const getIntVal = id => parseInt(uncomma(document.getElementById(id).value)) || 0;

  const car = getVal('carPrice');
  const discount = getVal('discount');
  const option = getVal('option');
  const total = car - discount + option;
  const rate = getVal('interestRate');
  const years = getIntVal('termYears');
  const months = years * 12;

  if (months === 0 || rate <= 0) {
      alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏µ‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢ (‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0) ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢.");
      return;
  }
  if (total <= 0) {
      alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ñ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå.");
      return;
  }

  let low = 0;
  let high = total;
  let bestDown = 0;
  let minDiff = Infinity;

  const maxIter = 500;

  for (let i = 0; i < maxIter; i++) {
    let currentDown = Math.round((low + high) / 2);

    if (currentDown < 0) currentDown = 0;
    if (currentDown > total) currentDown = total;

    const finance = total - currentDown;
    const intTotal = finance * (rate / 100) * years;
    const currentLease = months > 0 ? Math.ceil((finance + intTotal) / months) : 0;

    const diff = Math.abs(currentLease - targetLease);

    if (diff < minDiff) {
        minDiff = diff;
        bestDown = currentDown;
    }

    if (currentLease > targetLease) {
        low = currentDown;
    } else if (currentLease < targetLease) {
        high = currentDown;
    } else {
        bestDown = currentDown;
        break;
    }

    if (high - low <= 1 || minDiff < 0.1) {
        break;
    }
  }

  document.getElementById('downType').value = 'amount';
  document.getElementById('downInput').value = formatNoDecimal(bestDown);
  calculate();
}

function generateQuotation() {
    calculate();

    const data = {
        carInfo: document.getElementById('carInfo').value,
        carPrice: uncomma(document.getElementById('carPrice').value),
        discount: uncomma(document.getElementById('discount').value),
        option: uncomma(document.getElementById('option').value),
        totalAmount: uncomma(document.getElementById('totalAmount').value),
        downAmount: uncomma(document.getElementById('downAmount').value),
        downPercent: parseFloat(document.getElementById('downPercentDisplay').innerText.replace(/[()%]/g, '')),
        
        interestRate: uncomma(document.getElementById('interestRate').value),
        termYears: parseInt(document.getElementById('termYears').value) || 0,
        
        comBase: document.getElementById('comBase').value,
        comPercent: parseInt(document.getElementById('comPercent').value) || 0,
        calculatedCommission: uncomma(document.getElementById('calculatedCommission').value),
        extra: uncomma(document.getElementById('extra').value),
        qsExtra: uncomma(document.getElementById('qsExtra').value),

        financeAmt: uncomma(document.getElementById('financeAmt').value),
        intPA: uncomma(document.getElementById('intPA').value),
        intTotal: uncomma(document.getElementById('intTotal').value),
        financeTotalWithInterest: uncomma(document.getElementById('financeTotalWithInterest').value),
        leaseInVat: uncomma(document.getElementById('leaseInVat').value),
        leaseExVat: uncomma(document.getElementById('leaseExVat').value),
        trRate: parseFloat(document.getElementById('trRate').value.replace('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì', 'NaN')),
        
        qsCarInfo: document.getElementById('qsCarInfo').value,
        qsCarPrice: uncomma(document.getElementById('qsCarPrice').value),
        qsDiscount: uncomma(document.getElementById('qsDiscount').value),
        qsOption: uncomma(document.getElementById('qsOption').value),
        qsDownAmount: uncomma(document.getElementById('qsDownAmount').value),
        qsDownPercent: parseFloat(document.getElementById('qsDownPercent').value.replace(/[()%]/g, '')),
        qsTrRate: parseFloat(document.getElementById('qsTrRate').value.replace('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì', 'NaN')),
        qsTermYears: parseInt(document.getElementById('qsTermYears').value) || 0,
        qsDeposit: uncomma(document.getElementById('qsDeposit').value),
        qsRV: parseFloat(document.getElementById('qsRV').value.replace('%', '')),
        qsTrDep: parseFloat(document.getElementById('qsTrDep').value.replace('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì', 'NaN')),
    };

    localStorage.setItem('quotationData', JSON.stringify(data));
    window.open('quotation.html', '_blank');
}

function sendToQsData() {
    calculate();

    const dataForQs = {
        carInfo: document.getElementById('carInfo').value,
        carPrice: uncomma(document.getElementById('carPrice').value),
        discount: uncomma(document.getElementById('discount').value),
        option: uncomma(document.getElementById('option').value),
        totalAmount: uncomma(document.getElementById('totalAmount').value),

        qsExtraCost: uncomma(document.getElementById('qsExtra').value),
        downAmount: uncomma(document.getElementById('downAmount').value),
        qsDownPercent: parseFloat(document.getElementById('downPercentDisplay').innerText.replace(/[()%]/g, '')),
        trRateEffective: parseFloat(document.getElementById('trRate').value.replace('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì', 'NaN')),
        termYears: parseInt(document.getElementById('termYears').value) || 0,
        deposit: uncomma(document.getElementById('qsDeposit').value),
        rv: parseFloat(document.getElementById('qsRV').value.replace('%', '')),
        trDep: parseFloat(document.getElementById('qsTrDep').value.replace('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì', 'NaN')),
        leaseExVat: uncomma(document.getElementById('leaseExVat').value)
    };

    localStorage.setItem('qsData', JSON.stringify(dataForQs));
    window.open('qs_data.html', '_blank');
}

function exportToPdf() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4'); // 'p' for portrait, 'mm' for millimeters, 'a4' size

    // --- Font setup for Thai ---
    // Ensure Kanit-Regular.ttf and Kanit-SemiBold.ttf are in the SAME folder as index.html
    doc.addFont('Kanit-Regular.ttf', 'Kanit', 'normal');
    doc.addFont('Kanit-SemiBold.ttf', 'Kanit', 'bold');
    
    // Set default font for the document
    doc.setFont('Kanit');
    // --- End Font setup ---

    const margin = 15; // Left/Right margin
    let y = 15;         // Current Y position
    const lineHeight = 5; // Standard line height for text
    const smallLineHeight = 4; // Smaller line height for dense info
    const labelWidth = 80; // Width for the label column

    // Helper to add text line
    const addText = (text, x, yPos, size, style = 'normal', color = '#333333', align = 'left') => {
        doc.setFont('Kanit', style); // Set font family and style
        doc.setFontSize(size);
        doc.setTextColor(color);
        if (align === 'center') {
            doc.text(text, doc.internal.pageSize.width / 2, yPos, { align: 'center' });
        } else if (align === 'right') {
            doc.text(text, doc.internal.pageSize.width - x, yPos, { align: 'right' });
        } else {
            doc.text(text, x, yPos);
        }
    };

    // --- Title ---
    addText('Lease Calculation Report', doc.internal.pageSize.width / 2, y, 18, 'bold', '#003366', 'center');
    y += 8;

    addText(`‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${new Date().toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' })}`, margin, y, 8, 'normal', '#555555', 'right');
    y += 5;

    // --- Section: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô ---
    y += 5;
    doc.setDrawColor('#003366');
    doc.setLineWidth(0.5);
    doc.line(margin, y, doc.internal.pageSize.width - margin, y); // Line below heading
    addText('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô', margin, y + 4, 12, 'bold', '#003366');
    y += 10;
    
    addText('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏ñ:', margin, y, 9);
    addText(document.getElementById('carInfo').value, margin + labelWidth, y, 9, 'normal', '#003366');
    y += lineHeight;

    addText('‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ñ:', margin, y, 9);
    addText(document.getElementById('carPrice').value, margin + labelWidth, y, 9, 'normal', '#003366');
    y += lineHeight;

    addText('‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î:', margin, y, 9);
    addText(document.getElementById('discount').value, margin + labelWidth, y, 9, 'normal', '#003366');
    y += lineHeight;

    addText('Option:', margin, y, 9);
    addText(document.getElementById('option').value, margin + labelWidth, y, 9, 'normal', '#003366');
    y += lineHeight;

    addText('‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏∏‡∏ó‡∏ò‡∏¥:', margin, y, 9, 'bold');
    addText(document.getElementById('totalAmount').value, margin + labelWidth, y, 9, 'bold', '#E30613');
    y += lineHeight;

    // --- Section: ‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå ---
    y += 5;
    doc.line(margin, y, doc.internal.pageSize.width - margin, y);
    addText('‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå', margin, y + 4, 12, 'bold', '#003366');
    y += 10;

    addText('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå:', margin, y, 9);
    addText(document.getElementById('downType').options[document.getElementById('downType').selectedIndex].text, margin + labelWidth, y, 9, 'normal', '#003366');
    y += lineHeight;

    addText('‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå:', margin, y, 9);
    addText(document.getElementById('downAmount').value, margin + labelWidth, y, 9, 'normal', '#003366');
    y += lineHeight;

    addText('‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå‡∏Ñ‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô:', margin, y, 9);
    addText(document.getElementById('downPercentDisplay').innerText, margin + labelWidth, y, 9, 'bold', '#E30613');
    y += lineHeight;

    // --- Section: ‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤ ---
    y += 5;
    doc.line(margin, y, doc.internal.pageSize.width - margin, y);
    addText('‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤', margin, y + 4, 12, 'bold', '#003366');
    y += 10;

    addText('‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢ (%):', margin, y, 9);
    addText(document.getElementById('interestRate').value + '%', margin + labelWidth, y, 9, 'normal', '#003366');
    y += lineHeight;

    addText('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏µ:', margin, y, 9);
    addText(document.getElementById('termYears').value, margin + labelWidth, y, 9, 'normal', '#003366');
    y += lineHeight;

    // --- Section: ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô ---
    y += 5;
    doc.line(margin, y, doc.internal.pageSize.width - margin, y);
    addText('‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô', margin, y + 4, 12, 'bold', '#003366');
    y += 10;

    addText('‡∏Ñ‡∏¥‡∏î‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏à‡∏≤‡∏Å:', margin, y, 9);
    addText(document.getElementById('comBase').options[document.getElementById('comBase').selectedIndex].text, margin + labelWidth, y, 9, 'normal', '#003366');
    y += lineHeight;

    addText('Commission (%):', margin, y, 9);
    addText(document.getElementById('comPercent').value + '%', margin + labelWidth, y, 9, 'normal', '#003366');
    y += lineHeight;

    addText('‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏° (‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì):', margin, y, 9);
    addText(document.getElementById('calculatedCommission').value, margin + labelWidth, y, 9, 'normal', '#003366');
    y += lineHeight;

    addText('Extra Commission:', margin, y, 9);
    addText(document.getElementById('extra').value, margin + labelWidth, y, 9, 'normal', '#003366');
    y += lineHeight;

    addText('QS Extra Cost:', margin, y, 9, 'bold');
    addText(document.getElementById('qsExtra').value, margin + labelWidth, y, 9, 'bold', '#E30613');
    y += lineHeight;

    // --- Section: ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå ---
    y += 5;
    doc.line(margin, y, doc.internal.pageSize.width - margin, y);
    addText('‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå', margin, y + 4, 12, 'bold', '#003366');
    y += 10;

    addText('‡∏¢‡∏≠‡∏î‡∏à‡∏±‡∏î:', margin, y, 9);
    addText(document.getElementById('financeAmt').value, margin + labelWidth, y, 9, 'normal', '#003366');
    y += lineHeight;

    addText('‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏ï‡πà‡∏≠‡∏õ‡∏µ:', margin, y, 9);
    addText(document.getElementById('intPA').value, margin + labelWidth, y, 9, 'normal', '#003366');
    y += lineHeight;

    addText('‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏£‡∏ß‡∏°:', margin, y, 9);
    addText(document.getElementById('intTotal').value, margin + labelWidth, y, 9, 'normal', '#003366');
    y += lineHeight;

    addText('‡∏¢‡∏≠‡∏î‡∏à‡∏±‡∏î‡∏£‡∏ß‡∏°:', margin, y, 9);
    addText(document.getElementById('financeTotalWithInterest').value, margin + labelWidth, y, 9, 'normal', '#003366');
    y += lineHeight;

    addText('‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î (In VAT):', margin, y, 9, 'bold');
    addText(document.getElementById('leaseInVat').value, margin + labelWidth, y, 9, 'bold', '#E30613');
    y += lineHeight;

    addText('‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î (Ex VAT):', margin, y, 9);
    addText(document.getElementById('leaseExVat').value, margin + labelWidth, y, 9, 'normal', '#003366');
    y += lineHeight;

    addText('TR (Effective %):', margin, y, 9, 'bold');
    addText(document.getElementById('trRate').value, margin + labelWidth, y, 9, 'bold', '#E30613');
    y += lineHeight;

    // --- Section: QS Information ---
    y += 5;
    doc.line(margin, y, doc.internal.pageSize.width - margin, y);
    addText('QS Information', margin, y + 4, 12, 'bold', '#003366');
    y += 10;

    addText('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏ñ (QS):', margin, y, 9);
    addText(document.getElementById('qsCarInfo').value, margin + labelWidth, y, 9, 'normal', '#003366');
    y += lineHeight;

    addText('‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ñ (QS):', margin, y, 9);
    addText(document.getElementById('qsCarPrice').value, margin + labelWidth, y, 9, 'normal', '#003366');
    y += lineHeight;
    
    addText('‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î (QS):', margin, y, 9);
    addText(document.getElementById('qsDiscount').value, margin + labelWidth, y, 9, 'normal', '#003366');
    y += lineHeight;

    addText('Option (QS):', margin, y, 9);
    addText(document.getElementById('qsOption').value, margin + labelWidth, y, 9, 'normal', '#003366');
    y += lineHeight;

    addText('‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå (QS):', margin, y, 9);
    addText(document.getElementById('qsDownAmount').value, margin + labelWidth, y, 9, 'normal', '#003366');
    y += lineHeight;

    addText('‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå‡∏Ñ‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô % (QS):', margin, y, 9);
    addText(document.getElementById('qsDownPercent').value, margin + labelWidth, y, 9, 'normal', '#003366');
    y += lineHeight;

    addText('TR (Effective %) (QS):', margin, y, 9);
    addText(document.getElementById('qsTrRate').value, margin + labelWidth, y, 9, 'normal', '#003366');
    y += lineHeight;

    addText('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏µ (QS):', margin, y, 9);
    addText(document.getElementById('qsTermYears').value, margin + labelWidth, y, 9, 'normal', '#003366');
    y += lineHeight;

    addText('Deposit (QS):', margin, y, 9);
    addText(document.getElementById('qsDeposit').value, margin + labelWidth, y, 9, 'normal', '#003366');
    y += lineHeight;

    addText('RV (QS):', margin, y, 9);
    addText(document.getElementById('qsRV').value, margin + labelWidth, y, 9, 'normal', '#003366');
    y += lineHeight;

    addText('TR Dep (QS):', margin, y, 9);
    addText(document.getElementById('qsTrDep').value, margin + labelWidth, y, 9, 'normal', '#003366');
    y += lineHeight;


    // --- Note ---
    y += 5;
    doc.setDrawColor('#ffc107'); // Yellowish border for note
    doc.setLineWidth(0.5);
    doc.roundedRect(margin, y, doc.internal.pageSize.width - (2 * margin), 30, 3, 3, 'S'); // Draw a box for the note
    
    y += 4;
    addText('‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏£‡∏ó‡∏£‡∏≤‡∏ö:', margin + 2, y, 9, 'bold', '#856404');
    y += smallLineHeight;
    addText('  - ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î‡πÑ‡∏°‡πà‡∏•‡∏á‡∏ï‡∏±‡∏ß: ‡∏•‡∏≠‡∏á‡∏•‡∏î TR ‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏±‡∏ö Extra Cost ‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î‡∏•‡∏á‡∏ï‡∏±‡∏ß', margin + 2, y, 8, 'normal', '#856404');
    y += smallLineHeight;
    addText('  - ‡πÉ‡∏ö Deposit ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡πà‡∏≤ RV ‡∏ß‡πà‡∏≤‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ Purchase option ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà', margin + 2, y, 8, 'normal', '#856404');
    y += 10;


    doc.save('Lease_Calculation_Report.pdf');
}


// Event Listeners for input fields
function addInputListeners(id) {
  const el = document.getElementById(id);

  if (id === 'carInfo') {
      el.addEventListener('blur', calculate);
  } else { // All other number/percent inputs
      el.addEventListener('focus', () => {
          let currentVal = uncomma(el.value);
          if (Math.abs(currentVal) < 0.001) {
              el.value = '';
          } else {
              el.value = String(currentVal);
          }
      });
      el.addEventListener('blur', () => {
          let val = uncomma(el.value);
          if (id === 'termYears' || id === 'comPercent') {
              el.value = formatNoDecimal(val);
          } else if (id === 'interestRate') {
              el.value = format(val, 2);
          } else {
              el.value = format(val);
          }
          calculate();
      });
      el.addEventListener('input', () => {
          let sanitizedValue = el.value.replace(/[^0-9.]/g, '');
          const parts = sanitizedValue.split('.');
          if (parts.length > 2) {
              sanitizedValue = parts[0] + '.' + parts.slice(1).join('');
          }
          el.value = sanitizedValue;
      });
  }
}

window.onload = () => {
  ['carPrice', 'discount', 'option', 'downInput', 'interestRate', 'extra', 'termYears', 'comPercent', 'carInfo'].forEach(addInputListeners);
  document.getElementById('downType').addEventListener('change', calculate);
  document.getElementById('comBase').addEventListener('change', calculate);
  calculate();
};
</script>

</body>
</html>
